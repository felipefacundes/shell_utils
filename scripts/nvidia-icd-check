#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes

# NVIDIA Vulkan ICD configuration file path
ICD_FILE="/usr/share/vulkan/icd.d/nvidia_icd.json"

# Language support
declare -A MESSAGES

messages() {
    if [[ "${LANG,,}" =~ pt_ ]]; then
        # Portuguese messages
        MESSAGES=(
            ["check_root_error"]="âŒ Este script requer privilÃ©gios de superusuÃ¡rio (sudo)"
            ["check_root_usage"]="   Execute com: sudo ${0##*/} $*"
            ["run_cmd_executing"]="âš¡ Executando: $1"
            ["run_cmd_failed"]="âŒ Comando falhou: $1"
            ["find_libs_searching"]="ðŸ” Procurando bibliotecas NVIDIA disponÃ­veis..."
            ["find_libs_available"]="ðŸ“š Bibliotecas disponÃ­veis:"
            ["find_libs_vksc_found"]="âœ… [1] libnvidia-vksc-core.so.*: $VKSC_CORE_LIB (RECOMENDADO)"
            ["find_libs_vksc_not_found"]="âŒ [1] libnvidia-vksc-core.so.*: NÃ£o encontrada"
            ["find_libs_glcore_found"]="âœ… [2] libnvidia-glcore.so.*: $GL_CORE_LIB"
            ["find_libs_glcore_not_found"]="âŒ [2] libnvidia-glcore.so.*: NÃ£o encontrada"
            ["find_libs_gl_found"]="âœ… [3] libGL.so.1: $GL_LIB (fallback genÃ©rico)"
            ["find_libs_gl_not_found"]="âŒ [3] libGL.so.1: NÃ£o encontrada"
            ["find_libs_glx_warning"]="âš ï¸  [4] libGLX_nvidia.so.0: $GLX_NVIDIA_LIB (PROBLEMÃTICA - evitar)"
            ["find_libs_glx_not_found"]="âŒ [4] libGLX_nvidia.so.0: NÃ£o encontrada"
            ["check_issue_title"]="==================================================="
            ["check_issue_title2"]="Verificando configuraÃ§Ã£o do ICD Vulkan da NVIDIA"
            ["check_issue_file_not_found"]="âŒ Arquivo nÃ£o encontrado: $ICD_FILE"
            ["check_issue_driver_error"]="   O driver Vulkan da NVIDIA pode nÃ£o estar instalado corretamente."
            ["check_issue_solutions"]="ðŸ’¡ SoluÃ§Ãµes possÃ­veis:"
            ["check_issue_solution1"]="   1. Instale os drivers NVIDIA: sudo apt install nvidia-driver-XXX"
            ["check_issue_solution2"]="   2. Verifique se o pacote vulkan-icd-loader estÃ¡ instalado"
            ["check_issue_file_content"]="ðŸ“„ ConteÃºdo atual do arquivo $ICD_FILE:"
            ["check_issue_problem_found"]="âš ï¸  PROBLEMA ENCONTRADO!"
            ["check_issue_problem_desc"]="O arquivo contÃ©m referÃªncia problemÃ¡tica a 'libGLX_nvidia'"
            ["check_issue_problem_causes"]="ðŸ“Œ Pode causar:"
            ["check_issue_cause1"]="   â€¢ Erros em jogos/programas Vulkan"
            ["check_issue_cause2"]="   â€¢ Falhas e crashes"
            ["check_issue_cause3"]="   â€¢ Problemas de compatibilidade"
            ["check_issue_priority"]="ðŸŽ¯ ORDEM DE PRIORIDADE para bibliotecas ICD:"
            ["check_issue_priority1"]="   1. libnvidia-vksc-core.so.* (RECOMENDADO - principal para Vulkan)"
            ["check_issue_priority2"]="   2. libnvidia-glcore.so.* (alternativa)"
            ["check_issue_priority3"]="   3. libGL.so.1 (fallback genÃ©rico)"
            ["check_issue_priority4"]="   4. libGLX_nvidia.so.0 (PROBLEMÃTICA - evitar)"
            ["check_issue_problem_line"]="ðŸ” Linha problemÃ¡tica:"
            ["check_issue_config_ok"]="âœ… ConfiguraÃ§Ã£o OK!"
            ["check_issue_no_problem"]="Nenhuma referÃªncia problemÃ¡tica a 'libGLX_nvidia' encontrada."
            ["check_issue_current_lib"]="ðŸ“Œ Biblioteca atualmente configurada:"
            ["check_issue_no_library_path"]="NÃ£o encontrou 'library_path' no arquivo"
            ["choose_lib_title"]="ðŸŽ¯ SELECIONE A BIBLIOTECA PARA USAR:"
            ["choose_lib_option_vksc"]="[$option] libnvidia-vksc-core.so.* (RECOMENDADO para Vulkan)"
            ["choose_lib_option_glcore"]="[$option] libnvidia-glcore.so.*"
            ["choose_lib_option_gl"]="[$option] libGL.so.1 (fallback genÃ©rico)"
            ["choose_lib_option_glx"]="[$option] libGLX_nvidia.so.0 (ATUAL - NÃƒO RECOMENDADO)"
            ["choose_lib_option_cancel"]="[$option] Cancelar e sair"
            ["choose_lib_prompt"]="Digite o nÃºmero da sua escolha (1-$option): "
            ["choose_lib_cancelled"]="OperaÃ§Ã£o cancelada."
            ["choose_lib_selected"]="âœ… Selecionado: ${OPTIONS[$choice]}"
            ["choose_lib_invalid"]="âŒ OpÃ§Ã£o invÃ¡lida"
            ["fix_starting"]="ðŸ› ï¸  Iniciando correÃ§Ã£o..."
            ["fix_no_libs"]="âŒ Nenhuma biblioteca encontrada!"
            ["fix_install_driver"]="ðŸ’¡ Instale os drivers NVIDIA corretamente:"
            ["fix_install_cmd"]="   sudo apt update && sudo apt install nvidia-driver-XXX"
            ["fix_backup"]="ðŸ“‹ Fazendo backup do arquivo original..."
            ["fix_backup_created"]="âœ… Backup criado: $BACKUP_FILE"
            ["fix_backup_error"]="âŒ Erro ao criar backup!"
            ["fix_replacing"]="ðŸ”„ Substituindo biblioteca no arquivo de configuraÃ§Ã£o..."
            ["fix_current_lib"]="ðŸ“Œ Biblioteca atual: $CURRENT_LIB"
            ["fix_new_lib"]="ðŸ“Œ Nova biblioteca: $NEW_LIB"
            ["fix_temp_success"]="âœ… SubstituiÃ§Ã£o bem sucedida no arquivo temporÃ¡rio"
            ["fix_copy_success"]="âœ… Arquivo de configuraÃ§Ã£o atualizado!"
            ["fix_new_config"]="ðŸ“„ Nova configuraÃ§Ã£o:"
            ["fix_copy_error"]="âŒ Erro ao copiar arquivo de volta!"
            ["fix_restore_manual"]="   Restaure manualmente: cp \"$BACKUP_FILE\" \"$ICD_FILE\""
            ["fix_temp_failed"]="âŒ SubstituiÃ§Ã£o falhou no arquivo temporÃ¡rio"
            ["fix_edit_manual"]="   Tente corrigir manualmente editando: $ICD_FILE"
            ["fix_applied"]="âœ… CorreÃ§Ã£o aplicada com sucesso!"
            ["fix_restart_apps"]="ðŸ’¡ Reinicie os aplicativos Vulkan para aplicar as mudanÃ§as"
            ["auto_fix_starting"]="âš¡ CorreÃ§Ã£o automÃ¡tica nÃ£o-interativa..."
            ["auto_fix_priority1"]="âœ… Usando libnvidia-vksc-core.so.* (prioridade 1)"
            ["auto_fix_priority2"]="âœ… Usando libnvidia-glcore.so.* (prioridade 2)"
            ["auto_fix_fallback"]="âœ… Usando libGL.so.1 (fallback)"
            ["auto_fix_no_alt"]="âŒ Nenhuma biblioteca alternativa encontrada!"
            ["auto_fix_selected"]="ðŸ“„ Biblioteca selecionada: $NEW_LIB"
            ["auto_fix_backup"]="ðŸ“‹ Backup criado: $BACKUP_FILE"
            ["auto_fix_no_path"]="âŒ NÃ£o foi possÃ­vel encontrar 'library_path' no arquivo"
            ["auto_fix_replacing"]="ðŸ”„ Substituindo '$CURRENT_LIB' por '$NEW_LIB'"
            ["auto_fix_applied"]="âœ… CorreÃ§Ã£o aplicada automaticamente!"
            ["auto_fix_new_config"]="ðŸ“„ Nova configuraÃ§Ã£o:"
            ["auto_fix_error"]="âŒ Erro na correÃ§Ã£o automÃ¡tica!"
            ["auto_fix_restore"]="   Restaure o backup: cp \"$BACKUP_FILE\" \"$ICD_FILE\""
            ["check_driver_title"]="ðŸ” Verificando instalaÃ§Ã£o do driver NVIDIA..."
            ["check_driver_nvidia_found"]="âœ… nvidia-smi encontrado"
            ["check_driver_info"]="ðŸ“Š InformaÃ§Ãµes do driver:"
            ["check_driver_nvidia_not_found"]="âš ï¸  nvidia-smi nÃ£o encontrado"
            ["check_driver_install_error"]="   O driver NVIDIA pode nÃ£o estar instalado corretamente"
            ["check_vulkan_title"]="ðŸ” Verificando pacotes Vulkan..."
            ["check_vulkan_found"]="âœ… Pacotes Vulkan encontrados"
            ["check_vulkan_not_found"]="âš ï¸  Nenhum pacote Vulkan encontrado"
            ["main_no_fix_needed"]="âœ… Nenhuma correÃ§Ã£o necessÃ¡ria"
            ["main_check_driver"]="âœ… Sistema OK - Nenhuma aÃ§Ã£o necessÃ¡ria"
            ["main_commands_title"]="==================================================="
            ["main_commands_available"]="ðŸ’¡ COMANDOS DISPONÃVEIS (execute com sudo):"
            ["main_command_fix"]="   sudo ${0##*/} --fix     - CorreÃ§Ã£o interativa"
            ["main_command_auto"]="   sudo ${0##*/} --auto    - CorreÃ§Ã£o automÃ¡tica"
            ["main_command_check"]="   sudo ${0##*/} --check   - Apenas verificar"
            ["main_command_driver"]="   sudo ${0##*/} --driver  - Verificar driver"
            ["main_priority_title"]="ðŸ”§ A correÃ§Ã£o automÃ¡tica usa a ordem de prioridade:"
            ["main_priority1"]="   1. libnvidia-vksc-core.so.*"
            ["main_priority2"]="   2. libnvidia-glcore.so.*"
            ["main_priority3"]="   3. libGL.so.1"
            ["help_usage"]="Uso: sudo ${0##*/} [OPÃ‡ÃƒO]"
            ["help_options"]="OpÃ§Ãµes:"
            ["help_option_check"]="  --check, -c    Apenas verificar problemas (sem sudo)"
            ["help_option_fix"]="  --fix, -f      Verificar e corrigir interativamente (com sudo)"
            ["help_option_auto"]="  --auto, -a     CorreÃ§Ã£o automÃ¡tica nÃ£o-interativa (com sudo)"
            ["help_option_driver"]="  --driver, -d   Verificar instalaÃ§Ã£o do driver NVIDIA"
            ["help_option_help"]="  --help, -h     Mostrar esta ajuda"
            ["help_note"]="âš ï¸  NOTA: As opÃ§Ãµes --fix e --auto requerem privilÃ©gios de sudo"
            ["help_libs_title"]="ðŸ“š Bibliotecas recomendadas (ordem de prioridade):"
            ["help_lib1"]="  1. libnvidia-vksc-core.so.* (principal para Vulkan)"
            ["help_lib2"]="  2. libnvidia-glcore.so.*"
            ["help_lib3"]="  3. libGL.so.1 (fallback genÃ©rico)"
            ["help_lib4"]="  4. libGLX_nvidia.so.0 (PROBLEMÃTICA - evitar)"
            ["unknown_option"]="OpÃ§Ã£o desconhecida: $1"
            ["help_suggestion"]="Use: ${0##*/} --help para ver opÃ§Ãµes disponÃ­veis"
        )
    else
        # English messages (default)
        MESSAGES=(
            ["check_root_error"]="âŒ This script requires superuser privileges (sudo)"
            ["check_root_usage"]="   Run with: sudo ${0##*/} $*"
            ["run_cmd_executing"]="âš¡ Executing: $1"
            ["run_cmd_failed"]="âŒ Command failed: $1"
            ["find_libs_searching"]="ðŸ” Searching for available NVIDIA libraries..."
            ["find_libs_available"]="ðŸ“š Available libraries:"
            ["find_libs_vksc_found"]="âœ… [1] libnvidia-vksc-core.so.*: $VKSC_CORE_LIB (RECOMMENDED)"
            ["find_libs_vksc_not_found"]="âŒ [1] libnvidia-vksc-core.so.*: Not found"
            ["find_libs_glcore_found"]="âœ… [2] libnvidia-glcore.so.*: $GL_CORE_LIB"
            ["find_libs_glcore_not_found"]="âŒ [2] libnvidia-glcore.so.*: Not found"
            ["find_libs_gl_found"]="âœ… [3] libGL.so.1: $GL_LIB (generic fallback)"
            ["find_libs_gl_not_found"]="âŒ [3] libGL.so.1: Not found"
            ["find_libs_glx_warning"]="âš ï¸  [4] libGLX_nvidia.so.0: $GLX_NVIDIA_LIB (PROBLEMATIC - avoid)"
            ["find_libs_glx_not_found"]="âŒ [4] libGLX_nvidia.so.0: Not found"
            ["check_issue_title"]="==================================================="
            ["check_issue_title2"]="Checking NVIDIA Vulkan ICD configuration"
            ["check_issue_file_not_found"]="âŒ File not found: $ICD_FILE"
            ["check_issue_driver_error"]="   NVIDIA Vulkan driver may not be installed correctly."
            ["check_issue_solutions"]="ðŸ’¡ Possible solutions:"
            ["check_issue_solution1"]="   1. Install NVIDIA drivers: sudo apt install nvidia-driver-XXX"
            ["check_issue_solution2"]="   2. Check if vulkan-icd-loader package is installed"
            ["check_issue_file_content"]="ðŸ“„ Current content of $ICD_FILE:"
            ["check_issue_problem_found"]="âš ï¸  PROBLEM FOUND!"
            ["check_issue_problem_desc"]="The file contains problematic reference to 'libGLX_nvidia'"
            ["check_issue_problem_causes"]="ðŸ“Œ Can cause:"
            ["check_issue_cause1"]="   â€¢ Errors in Vulkan games/programs"
            ["check_issue_cause2"]="   â€¢ Crashes and failures"
            ["check_issue_cause3"]="   â€¢ Compatibility issues"
            ["check_issue_priority"]="ðŸŽ¯ PRIORITY ORDER for ICD libraries:"
            ["check_issue_priority1"]="   1. libnvidia-vksc-core.so.* (RECOMMENDED - main for Vulkan)"
            ["check_issue_priority2"]="   2. libnvidia-glcore.so.* (alternative)"
            ["check_issue_priority3"]="   3. libGL.so.1 (generic fallback)"
            ["check_issue_priority4"]="   4. libGLX_nvidia.so.0 (PROBLEMATIC - avoid)"
            ["check_issue_problem_line"]="ðŸ” Problematic line:"
            ["check_issue_config_ok"]="âœ… Configuration OK!"
            ["check_issue_no_problem"]="No problematic reference to 'libGLX_nvidia' found."
            ["check_issue_current_lib"]="ðŸ“Œ Currently configured library:"
            ["check_issue_no_library_path"]="Did not find 'library_path' in file"
            ["choose_lib_title"]="ðŸŽ¯ SELECT LIBRARY TO USE:"
            ["choose_lib_option_vksc"]="[$option] libnvidia-vksc-core.so.* (RECOMMENDED for Vulkan)"
            ["choose_lib_option_glcore"]="[$option] libnvidia-glcore.so.*"
            ["choose_lib_option_gl"]="[$option] libGL.so.1 (generic fallback)"
            ["choose_lib_option_glx"]="[$option] libGLX_nvidia.so.0 (CURRENT - NOT RECOMMENDED)"
            ["choose_lib_option_cancel"]="[$option] Cancel and exit"
            ["choose_lib_prompt"]="Enter your choice number (1-$option): "
            ["choose_lib_cancelled"]="Operation cancelled."
            ["choose_lib_selected"]="âœ… Selected: ${OPTIONS[$choice]}"
            ["choose_lib_invalid"]="âŒ Invalid option"
            ["fix_starting"]="ðŸ› ï¸  Starting fix..."
            ["fix_no_libs"]="âŒ No libraries found!"
            ["fix_install_driver"]="ðŸ’¡ Install NVIDIA drivers correctly:"
            ["fix_install_cmd"]="   sudo apt update && sudo apt install nvidia-driver-XXX"
            ["fix_backup"]="ðŸ“‹ Creating backup of original file..."
            ["fix_backup_created"]="âœ… Backup created: $BACKUP_FILE"
            ["fix_backup_error"]="âŒ Error creating backup!"
            ["fix_replacing"]="ðŸ”„ Replacing library in configuration file..."
            ["fix_current_lib"]="ðŸ“Œ Current library: $CURRENT_LIB"
            ["fix_new_lib"]="ðŸ“Œ New library: $NEW_LIB"
            ["fix_temp_success"]="âœ… Successful replacement in temporary file"
            ["fix_copy_success"]="âœ… Configuration file updated!"
            ["fix_new_config"]="ðŸ“„ New configuration:"
            ["fix_copy_error"]="âŒ Error copying file back!"
            ["fix_restore_manual"]="   Restore manually: cp \"$BACKUP_FILE\" \"$ICD_FILE\""
            ["fix_temp_failed"]="âŒ Replacement failed in temporary file"
            ["fix_edit_manual"]="   Try to fix manually by editing: $ICD_FILE"
            ["fix_applied"]="âœ… Fix applied successfully!"
            ["fix_restart_apps"]="ðŸ’¡ Restart Vulkan applications to apply changes"
            ["auto_fix_starting"]="âš¡ Non-interactive automatic fix..."
            ["auto_fix_priority1"]="âœ… Using libnvidia-vksc-core.so.* (priority 1)"
            ["auto_fix_priority2"]="âœ… Using libnvidia-glcore.so.* (priority 2)"
            ["auto_fix_fallback"]="âœ… Using libGL.so.1 (fallback)"
            ["auto_fix_no_alt"]="âŒ No alternative libraries found!"
            ["auto_fix_selected"]="ðŸ“„ Selected library: $NEW_LIB"
            ["auto_fix_backup"]="ðŸ“‹ Backup created: $BACKUP_FILE"
            ["auto_fix_no_path"]="âŒ Could not find 'library_path' in file"
            ["auto_fix_replacing"]="ðŸ”„ Replacing '$CURRENT_LIB' with '$NEW_LIB'"
            ["auto_fix_applied"]="âœ… Automatic fix applied!"
            ["auto_fix_new_config"]="ðŸ“„ New configuration:"
            ["auto_fix_error"]="âŒ Error in automatic fix!"
            ["auto_fix_restore"]="   Restore backup: cp \"$BACKUP_FILE\" \"$ICD_FILE\""
            ["check_driver_title"]="ðŸ” Checking NVIDIA driver installation..."
            ["check_driver_nvidia_found"]="âœ… nvidia-smi found"
            ["check_driver_info"]="ðŸ“Š Driver information:"
            ["check_driver_nvidia_not_found"]="âš ï¸  nvidia-smi not found"
            ["check_driver_install_error"]="   NVIDIA driver may not be installed correctly"
            ["check_vulkan_title"]="ðŸ” Checking Vulkan packages..."
            ["check_vulkan_found"]="âœ… Vulkan packages found"
            ["check_vulkan_not_found"]="âš ï¸  No Vulkan packages found"
            ["main_no_fix_needed"]="âœ… No fix needed"
            ["main_check_driver"]="âœ… System OK - No action needed"
            ["main_commands_title"]="==================================================="
            ["main_commands_available"]="ðŸ’¡ AVAILABLE COMMANDS (run with sudo):"
            ["main_command_fix"]="   sudo ${0##*/} --fix     - Interactive fix"
            ["main_command_auto"]="   sudo ${0##*/} --auto    - Automatic fix"
            ["main_command_check"]="   sudo ${0##*/} --check   - Check only"
            ["main_command_driver"]="   sudo ${0##*/} --driver  - Check driver"
            ["main_priority_title"]="ðŸ”§ Automatic fix uses priority order:"
            ["main_priority1"]="   1. libnvidia-vksc-core.so.*"
            ["main_priority2"]="   2. libnvidia-glcore.so.*"
            ["main_priority3"]="   3. libGL.so.1"
            ["help_usage"]="Usage: sudo ${0##*/} [OPTION]"
            ["help_options"]="Options:"
            ["help_option_check"]="  --check, -c    Check for problems only (no sudo)"
            ["help_option_fix"]="  --fix, -f      Check and fix interactively (with sudo)"
            ["help_option_auto"]="  --auto, -a     Non-interactive automatic fix (with sudo)"
            ["help_option_driver"]="  --driver, -d   Check NVIDIA driver installation"
            ["help_option_help"]="  --help, -h     Show this help"
            ["help_note"]="âš ï¸  NOTE: --fix and --auto options require sudo privileges"
            ["help_libs_title"]="ðŸ“š Recommended libraries (priority order):"
            ["help_lib1"]="  1. libnvidia-vksc-core.so.* (main for Vulkan)"
            ["help_lib2"]="  2. libnvidia-glcore.so.*"
            ["help_lib3"]="  3. libGL.so.1 (generic fallback)"
            ["help_lib4"]="  4. libGLX_nvidia.so.0 (PROBLEMATIC - avoid)"
            ["unknown_option"]="Unknown option: $1"
            ["help_suggestion"]="Use: ${0##*/} --help to see available options"
        )
    fi
}

messages "$*"

# Function to check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo "${MESSAGES[check_root_error]}"
        echo "${MESSAGES[check_root_usage]}"
        exit 1
    fi
}

# Function to execute commands with feedback
run_cmd() {
    echo "${MESSAGES[run_cmd_executing]}"
    eval "$1"
    if [ $? -ne 0 ]; then
        echo "${MESSAGES[run_cmd_failed]}"
        return 1
    fi
    return 0
}

# Function to find available libraries
find_available_libs() {
    echo "${MESSAGES[find_libs_searching]}"
    
    # Priority 1: libnvidia-vksc-core (main for Vulkan)
    VKSC_CORE_LIB=$(find /usr/lib* /usr/lib64 /usr/lib/x86_64-linux-gnu -name "libnvidia-vksc-core.so.*" 2>/dev/null | head -1)
    
    # Priority 2: libnvidia-glcore (alternative)
    GL_CORE_LIB=$(find /usr/lib* /usr/lib64 /usr/lib/x86_64-linux-gnu -name "libnvidia-glcore.so.*" 2>/dev/null | head -1)
    
    # Fallback: libGL.so.1 (generic)
    GL_LIB="/usr/lib/libGL.so.1"
    if [ ! -f "$GL_LIB" ]; then
        GL_LIB=$(find /usr/lib* /usr/lib64 -name "libGL.so.1" 2>/dev/null | head -1)
    fi
    
    # Fallback 2: libGLX_nvidia.so.0 (original - if nothing else works)
    GLX_NVIDIA_LIB=$(find /usr/lib* /usr/lib64 -name "libGLX_nvidia.so.0" 2>/dev/null | head -1)
    
    # Show found libraries
    echo ""
    echo "${MESSAGES[find_libs_available]}"
    if [ -n "$VKSC_CORE_LIB" ] && [ -f "$VKSC_CORE_LIB" ]; then
        echo "${MESSAGES[find_libs_vksc_found]}"
    else
        echo "${MESSAGES[find_libs_vksc_not_found]}"
    fi
    
    if [ -n "$GL_CORE_LIB" ] && [ -f "$GL_CORE_LIB" ]; then
        echo "${MESSAGES[find_libs_glcore_found]}"
    else
        echo "${MESSAGES[find_libs_glcore_not_found]}"
    fi
    
    if [ -n "$GL_LIB" ] && [ -f "$GL_LIB" ]; then
        echo "${MESSAGES[find_libs_gl_found]}"
    else
        echo "${MESSAGES[find_libs_gl_not_found]}"
    fi
    
    if [ -n "$GLX_NVIDIA_LIB" ] && [ -f "$GLX_NVIDIA_LIB" ]; then
        echo "${MESSAGES[find_libs_glx_warning]}"
    else
        echo "${MESSAGES[find_libs_glx_not_found]}"
    fi
    
    echo ""
}

# Function to check the issue
check_issue() {
    echo "${MESSAGES[check_issue_title]}"
    echo "${MESSAGES[check_issue_title2]}"
    echo "${MESSAGES[check_issue_title]}"
    
    # Check if file exists
    if [ ! -f "$ICD_FILE" ]; then
        echo "${MESSAGES[check_issue_file_not_found]}"
        echo "${MESSAGES[check_issue_driver_error]}"
        echo ""
        echo "${MESSAGES[check_issue_solutions]}"
        echo "${MESSAGES[check_issue_solution1]}"
        echo "${MESSAGES[check_issue_solution2]}"
        return 2
    fi
    
    # Show available libraries first
    find_available_libs
    
    echo "${MESSAGES[check_issue_file_content]}"
    echo "---------------------------------------------------"
    cat "$ICD_FILE"
    echo "---------------------------------------------------"
    
    if grep -q "libGLX_nvidia" "$ICD_FILE"; then
        echo ""
        echo "${MESSAGES[check_issue_problem_found]}"
        echo "---------------------------------------------------"
        echo "${MESSAGES[check_issue_problem_desc]}"
        echo ""
        echo "${MESSAGES[check_issue_problem_causes]}"
        echo "${MESSAGES[check_issue_cause1]}"
        echo "${MESSAGES[check_issue_cause2]}"
        echo "${MESSAGES[check_issue_cause3]}"
        echo ""
        echo "${MESSAGES[check_issue_priority]}"
        echo "${MESSAGES[check_issue_priority1]}"
        echo "${MESSAGES[check_issue_priority2]}"
        echo "${MESSAGES[check_issue_priority3]}"
        echo "${MESSAGES[check_issue_priority4]}"
        echo ""
        
        # Show problematic line
        echo "${MESSAGES[check_issue_problem_line]}"
        grep "libGLX_nvidia" "$ICD_FILE"
        
        return 1
    else
        echo "${MESSAGES[check_issue_config_ok]}"
        echo "${MESSAGES[check_issue_no_problem]}"
        echo ""
        echo "${MESSAGES[check_issue_current_lib]}"
        grep "library_path" "$ICD_FILE" || echo "${MESSAGES[check_issue_no_library_path]}"
        return 0
    fi
}

# Function to choose library
choose_library() {
    local vksc_core=$1
    local gl_core=$2
    local gl_lib=$3
    local glx_nvidia=$4
    
    echo ""
    echo "${MESSAGES[choose_lib_title]}"
    echo ""
    
    local option=1
    
    if [ -n "$vksc_core" ] && [ -f "$vksc_core" ]; then
        echo "${MESSAGES[choose_lib_option_vksc]}"
        echo "      $vksc_core"
        OPTIONS[$option]="$vksc_core"
        ((option++))
    fi
    
    if [ -n "$gl_core" ] && [ -f "$gl_core" ]; then
        echo "${MESSAGES[choose_lib_option_glcore]}"
        echo "      $gl_core"
        OPTIONS[$option]="$gl_core"
        ((option++))
    fi
    
    if [ -n "$gl_lib" ] && [ -f "$gl_lib" ]; then
        echo "${MESSAGES[choose_lib_option_gl]}"
        echo "      $gl_lib"
        OPTIONS[$option]="$gl_lib"
        ((option++))
    fi
    
    if [ -n "$glx_nvidia" ] && [ -f "$glx_nvidia" ]; then
        echo "${MESSAGES[choose_lib_option_glx]}"
        echo "      $glx_nvidia"
        OPTIONS[$option]="$glx_nvidia"
        ((option++))
    fi
    
    echo "${MESSAGES[choose_lib_option_cancel]}"
    OPTIONS[$option]="cancel"
    
    echo ""
    read -rp "${MESSAGES[choose_lib_prompt]}" choice
    
    if [[ $choice =~ ^[0-9]+$ ]] && [ $choice -ge 1 ] && [ $choice -le $option ]; then
        if [ "${OPTIONS[$choice]}" == "cancel" ]; then
            echo "${MESSAGES[choose_lib_cancelled]}"
            return 0
        else
            echo "${MESSAGES[choose_lib_selected]}"
            NEW_LIB="${OPTIONS[$choice]}"
            return 1
        fi
    else
        echo "${MESSAGES[choose_lib_invalid]}"
        return 0
    fi
}

# Function to fix the issue
fix_issue() {
    echo ""
    echo "${MESSAGES[fix_starting]}"
    
    # Find available libraries
    VKSC_CORE_LIB=$(find /usr/lib* /usr/lib64 /usr/lib/x86_64-linux-gnu -name "libnvidia-vksc-core.so.*" 2>/dev/null | head -1)
    GL_CORE_LIB=$(find /usr/lib* /usr/lib64 /usr/lib/x86_64-linux-gnu -name "libnvidia-glcore.so.*" 2>/dev/null | head -1)
    GL_LIB=$(find /usr/lib* /usr/lib64 -name "libGL.so.1" 2>/dev/null | head -1)
    GLX_NVIDIA_LIB=$(find /usr/lib* /usr/lib64 -name "libGLX_nvidia.so.0" 2>/dev/null | head -1)
    
    # Check if any library is available
    if [ -z "$VKSC_CORE_LIB" ] && [ -z "$GL_CORE_LIB" ] && [ -z "$GL_LIB" ] && [ -z "$GLX_NVIDIA_LIB" ]; then
        echo "${MESSAGES[fix_no_libs]}"
        echo "${MESSAGES[fix_install_driver]}"
        echo "${MESSAGES[fix_install_cmd]}"
        exit 1
    fi
    
    # Offer interactive choice
    declare -A OPTIONS
    choose_library "$VKSC_CORE_LIB" "$GL_CORE_LIB" "$GL_LIB" "$GLX_NVIDIA_LIB"
    local choice_result=$?
    
    if [ $choice_result -eq 0 ]; then
        exit 0
    fi
    
    echo ""
    echo "${MESSAGES[fix_backup]}"
    
    # Create backup
    BACKUP_FILE="${ICD_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
    run_cmd "cp \"$ICD_FILE\" \"$BACKUP_FILE\""
    
    if [ $? -eq 0 ]; then
        echo "${MESSAGES[fix_backup_created]}"
    else
        echo "${MESSAGES[fix_backup_error]}"
        exit 1
    fi
    
    echo ""
    echo "${MESSAGES[fix_replacing]}"
    
    # Create temporary backup for manipulation
    TMP_FILE="/tmp/nvidia_icd_temp.json"
    cp "$ICD_FILE" "$TMP_FILE"
    
    # Extract current library path
    CURRENT_LIB=$(grep -o '"library_path":[[:space:]]*"[^"]*"' "$ICD_FILE" | cut -d'"' -f4)
    
    echo "${MESSAGES[fix_current_lib]}"
    echo "${MESSAGES[fix_new_lib]}"
    
    # Replace in temporary file
    sed -i "s|${CURRENT_LIB}|${NEW_LIB}|g" "$TMP_FILE"
    
    # Check if replacement worked
    if grep -q "$NEW_LIB" "$TMP_FILE"; then
        echo "${MESSAGES[fix_temp_success]}"
        
        # Copy back with original permissions
        run_cmd "cp \"$TMP_FILE\" \"$ICD_FILE\""
        
        if [ $? -eq 0 ]; then
            echo "${MESSAGES[fix_copy_success]}"
            
            # Restore permissions if needed
            ORIG_PERMS=$(stat -c "%a" "$BACKUP_FILE")
            run_cmd "chmod $ORIG_PERMS \"$ICD_FILE\""
            
            echo ""
            echo "${MESSAGES[fix_new_config]}"
            echo "---------------------------------------------------"
            cat "$ICD_FILE"
            echo "---------------------------------------------------"
            
            # Clean temporary file
            rm -f "$TMP_FILE"
            
            echo ""
            echo "${MESSAGES[fix_applied]}"
            echo "${MESSAGES[fix_restart_apps]}"
        else
            echo "${MESSAGES[fix_copy_error]}"
            echo "${MESSAGES[fix_restore_manual]}"
            exit 1
        fi
    else
        echo "${MESSAGES[fix_temp_failed]}"
        echo "${MESSAGES[fix_edit_manual]}"
        exit 1
    fi
}

# Function for automatic fix (non-interactive)
fix_auto() {
    echo ""
    echo "${MESSAGES[auto_fix_starting]}"
    
    # Find libraries in priority order
    VKSC_CORE_LIB=$(find /usr/lib* /usr/lib64 /usr/lib/x86_64-linux-gnu -name "libnvidia-vksc-core.so.*" 2>/dev/null | head -1)
    GL_CORE_LIB=$(find /usr/lib* /usr/lib64 /usr/lib/x86_64-linux-gnu -name "libnvidia-glcore.so.*" 2>/dev/null | head -1)
    GL_LIB=$(find /usr/lib* /usr/lib64 -name "libGL.so.1" 2>/dev/null | head -1)
    
    # Choose library in priority order
    if [ -n "$VKSC_CORE_LIB" ] && [ -f "$VKSC_CORE_LIB" ]; then
        NEW_LIB="$VKSC_CORE_LIB"
        echo "${MESSAGES[auto_fix_priority1]}"
    elif [ -n "$GL_CORE_LIB" ] && [ -f "$GL_CORE_LIB" ]; then
        NEW_LIB="$GL_CORE_LIB"
        echo "${MESSAGES[auto_fix_priority2]}"
    elif [ -n "$GL_LIB" ] && [ -f "$GL_LIB" ]; then
        NEW_LIB="$GL_LIB"
        echo "${MESSAGES[auto_fix_fallback]}"
    else
        echo "${MESSAGES[auto_fix_no_alt]}"
        echo "${MESSAGES[fix_install_driver]}"
        exit 1
    fi
    
    echo "${MESSAGES[auto_fix_selected]}"
    
    # Create backup
    BACKUP_FILE="${ICD_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
    run_cmd "cp \"$ICD_FILE\" \"$BACKUP_FILE\""
    echo "${MESSAGES[auto_fix_backup]}"
    
    # Extract current path
    CURRENT_LIB=$(grep -o '"library_path":[[:space:]]*"[^"]*"' "$ICD_FILE" | cut -d'"' -f4)
    
    if [ -z "$CURRENT_LIB" ]; then
        echo "${MESSAGES[auto_fix_no_path]}"
        exit 1
    fi
    
    # Apply fix
    echo "${MESSAGES[auto_fix_replacing]}"
    
    # Use sed for replacement
    sed -i "s|${CURRENT_LIB}|${NEW_LIB}|g" "$ICD_FILE"
    
    if [ $? -eq 0 ]; then
        echo "${MESSAGES[auto_fix_applied]}"
        echo ""
        echo "${MESSAGES[auto_fix_new_config]}"
        grep "library_path" "$ICD_FILE"
    else
        echo "${MESSAGES[auto_fix_error]}"
        echo "${MESSAGES[auto_fix_restore]}"
        exit 1
    fi
}

# Function to check driver installation
check_driver() {
    echo "${MESSAGES[check_driver_title]}"
    
    if command -v nvidia-smi &> /dev/null; then
        echo "${MESSAGES[check_driver_nvidia_found]}"
        echo ""
        echo "${MESSAGES[check_driver_info]}"
        nvidia-smi --query-gpu=driver_version,name --format=csv
    else
        echo "${MESSAGES[check_driver_nvidia_not_found]}"
        echo "${MESSAGES[check_driver_install_error]}"
    fi
    
    echo ""
    echo "${MESSAGES[check_vulkan_title]}"
    
    if dpkg -l | grep -q vulkan; then
        echo "${MESSAGES[check_vulkan_found]}"
        dpkg -l | grep vulkan | awk '{print "   â€¢ "$2" ("$3")"}'
    else
        echo "${MESSAGES[check_vulkan_not_found]}"
    fi
}

# Main execution
case "${1:-}" in
    "--fix"|"-f")
        check_root
        check_issue
        case $? in
            0) echo "${MESSAGES[main_no_fix_needed]}"; exit 0 ;;
            1) fix_issue ;;
            2) check_driver; exit 1 ;;
        esac
        ;;
    "--auto"|"-a")
        check_root
        check_issue
        if [ $? -eq 1 ]; then
            fix_auto
        elif [ $? -eq 0 ]; then
            echo "${MESSAGES[main_no_fix_needed]}"
        else
            check_driver
        fi
        ;;
    "--check"|"-c"|"")
        check_issue
        case $? in
            0) echo "${MESSAGES[main_check_driver]}" ;;
            1) 
                echo ""
                echo "${MESSAGES[main_commands_title]}"
                echo "${MESSAGES[main_commands_available]}"
                echo "${MESSAGES[main_command_fix]}"
                echo "${MESSAGES[main_command_auto]}"
                echo "${MESSAGES[main_command_check]}"
                echo "${MESSAGES[main_command_driver]}"
                echo ""
                echo "${MESSAGES[main_priority_title]}"
                echo "${MESSAGES[main_priority1]}"
                echo "${MESSAGES[main_priority2]}"
                echo "${MESSAGES[main_priority3]}"
                ;;
            2) check_driver ;;
        esac
        ;;
    "--driver"|"-d")
        check_driver
        ;;
    "--help"|"-h")
        echo "${MESSAGES[help_usage]}"
        echo ""
        echo "${MESSAGES[help_options]}"
        echo "${MESSAGES[help_option_check]}"
        echo "${MESSAGES[help_option_fix]}"
        echo "${MESSAGES[help_option_auto]}"
        echo "${MESSAGES[help_option_driver]}"
        echo "${MESSAGES[help_option_help]}"
        echo ""
        echo "${MESSAGES[help_note]}"
        echo ""
        echo "${MESSAGES[help_libs_title]}"
        echo "${MESSAGES[help_lib1]}"
        echo "${MESSAGES[help_lib2]}"
        echo "${MESSAGES[help_lib3]}"
        echo "${MESSAGES[help_lib4]}"
        ;;
    *)
        echo "${MESSAGES[unknown_option]}"
        echo "${MESSAGES[help_suggestion]}"
        exit 1
        ;;
esac

exit 0