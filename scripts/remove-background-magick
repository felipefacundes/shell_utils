#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes
# Script completo para remoção de fundo com múltiplas opções

: <<'DOCUMENTATION'
Background Removal Bash Utility

A Bash script that uses ImageMagick to remove specific color backgrounds from PNG images.
Supports multiple removal methods and adjustable fuzz tolerance.

Key Features:
1. Batch PNG image processing
2. Multiple removal methods: simple, fuzz, or mask
3. Adjustable fuzz tolerance via argument
4. Clean edge handling
DOCUMENTATION

# Display help
show_help() {
    echo "Usage: ${0##*/} <input_dir> <output_dir> <color_hex> [options]"
    echo ""
    echo "Required arguments:"
    echo "  <input_dir>      Directory with input PNG images"
    echo "  <output_dir>     Directory for processed images"
    echo "  <color_hex>      Color to remove (format: RRGGBB or #RRGGBB)"
    echo ""
    echo "Optional arguments:"
    echo "  -m, --method METHOD   Removal method: simple, fuzz (default), mask"
    echo "  -f, --fuzz PERCENT    Fuzz tolerance percentage (default: 15%)"
    echo "  -h, --help            Show this help message"
    echo ""
    echo "Examples:"
    echo "  ${0##*/} entrada saida d0d0d0                    # Default method, 15% fuzz"
    echo "  ${0##*/} entrada saida #FF0000 -m simple         # Simple transparent method"
    echo "  ${0##*/} entrada saida 00FF00 -m fuzz -f 20      # Fuzz method with 20% tolerance"
    echo "  ${0##*/} entrada saida 0000FF -m mask            # Mask method (best quality)"
    echo ""
    echo "Method descriptions:"
    echo "  simple:   magick input -transparent COLOR output (fast, basic)"
    echo "  fuzz:     magick input -fuzz X% -transparent COLOR output (recommended)"
    echo "  mask:     Creates a mask first for cleaner edges (slow, best quality)"
}

# Check minimum arguments
if [ "$#" -lt 3 ]; then
    show_help
    exit 1
fi

# Parse arguments
input_directory="$1"
output_directory="$2"
color_input="$3"
shift 3

# Default values
METHOD="fuzz"
FUZZ_PERCENT="15%"

# Parse optional arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -m|--method)
            METHOD="$2"
            shift 2
            ;;
        -f|--fuzz)
            # Remove % if provided and add it back
            FUZZ_PERCENT="${2//%/}%"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

# Validate method
if [[ ! "$METHOD" =~ ^(simple|fuzz|mask)$ ]]; then
    echo "Error: Method must be 'simple', 'fuzz', or 'mask'"
    exit 1
fi

# Normalize color format
if [[ $color_input != \#* ]]; then
    color_hex="#$color_input"
else
    color_hex="$color_input"
fi

# Creates output directory if it does not exist
mkdir -p "$output_directory"

# Counter for processed images
processed=0
failed=0

echo "========================================"
echo "Image Background Removal Tool"
echo "========================================"
echo "Input directory:  $input_directory"
echo "Output directory: $output_directory"
echo "Color to remove:  $color_hex"
echo "Method:           $METHOD"
if [[ "$METHOD" == "fuzz" ]]; then
    echo "Fuzz tolerance:   $FUZZ_PERCENT"
fi
echo "========================================"

# Process images
for input_image in "$input_directory"/*.png; do
    # Skip if no PNG files found
    [ -f "$input_image" ] || continue
    
    filename=$(basename -- "$input_image")
    filename_noext="${filename%.*}"
    
    echo -n "Processing $filename... "
    
    # Create temp directory for mask method
    if [[ "$METHOD" == "mask" ]]; then
        temp_dir="$output_directory/temp_$$"
        mkdir -p "$temp_dir"
    fi
    
    case $METHOD in
        simple)
            # SIMPLE METHOD: Basic transparent
            if magick "$input_image" \
                -transparent "$color_hex" \
                "$output_directory/$filename" 2>/dev/null; then
                echo "✓"
                ((processed++))
            else
                echo "✗"
                ((failed++))
            fi
            ;;
        
        fuzz)
            # FUZZ METHOD: With tolerance
            if magick "$input_image" \
                -fuzz "$FUZZ_PERCENT" \
                -transparent "$color_hex" \
                -channel A -threshold 10% +channel \
                "$output_directory/$filename" 2>/dev/null; then
                echo "✓"
                ((processed++))
            else
                echo "✗"
                ((failed++))
            fi
            ;;
        
        mask)
            # MASK METHOD: Best quality with mask creation
            # Step 1: Create mask
            if ! magick "$input_image" \
                -fill white -fuzz "$FUZZ_PERCENT" -opaque "$color_hex" \
                -fill black +opaque white \
                -alpha off \
                "$temp_dir/mask.png" 2>/dev/null; then
                echo "✗ (mask failed)"
                ((failed++))
                rm -rf "$temp_dir"
                continue
            fi
            
            # Step 2: Apply mask
            if magick "$input_image" \
                "$temp_dir/mask.png" \
                -alpha off \
                -compose Copy_Opacity -composite \
                -trim +repage \
                "$output_directory/$filename" 2>/dev/null; then
                echo "✓"
                ((processed++))
            else
                echo "✗ (apply failed)"
                ((failed++))
            fi
            
            # Clean up
            rm -rf "$temp_dir"
            ;;
    esac
done

# Summary
echo "========================================"
echo "Processing complete!"
echo "Successfully processed: $processed images"
if [ $failed -gt 0 ]; then
    echo "Failed to process: $failed images"
fi
echo "========================================"