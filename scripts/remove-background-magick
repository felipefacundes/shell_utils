#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes
# Modificado para remoção de cor específica com tolerância

: <<'DOCUMENTATION'
Background Removal Bash Utility

A Bash script that uses ImageMagick to automatically remove specific color backgrounds from PNG images.
The tool uses color fuzz tolerance for cleaner removal of defined colors.

Key Features:
1. Batch PNG image processing
2. Color-specific removal with tolerance control
3. Edge refinement for better quality
4. Supports hex colors with or without #
DOCUMENTATION

# Check if the number of arguments is appropriate
if [ "$#" -ne 3 ]; then
    echo "Usage: ${0##*/} <input_directory> <output_directory> <color_hex>"
    echo "Color hex format: RRGGBB or #RRGGBB (e.g., d0d0d0 or #d0d0d0)"
    echo "For gray #d0d0d0, try fuzz values between 10-25% for best results"
    exit 1
fi

# Attribute arguments to variables
input_directory="$1"
output_directory="$2"
color_input="$3"

# Normalize color format (ensure it has #)
if [[ $color_input != \#* ]]; then
    color_hex="#$color_input"
else
    color_hex="$color_input"
fi

# Creates exit directory if it does not exist
mkdir -p "$output_directory"

# Counter for processed images
processed=0
failed=0

# FUZZ TOLERANCE - Adjust this value for your needs
# Lower = more precise but may leave halos
# Higher = more aggressive but may eat into subject
# For #d0d0d0 gray, start with 15%
FUZZ_PERCENT="15%"

echo "Using color: $color_hex with $FUZZ_PERCENT fuzz tolerance"

# Iterate through all images in the entrance directory
for input_image in "$input_directory"/*.png; do
    # Skip if no PNG files found
    [ -f "$input_image" ] || continue
    
    # Get the file name without the path and the extension
    filename=$(basename -- "$input_image")
    filename_noext="${filename%.*}"
    
    echo "Processing $filename..."
    
    # Create temporary directory for intermediate files
    temp_dir="$output_directory/temp_$$"
    mkdir -p "$temp_dir"
    
    # METHOD 1: Direct fuzz transparency (simpler, faster)
    if ! magick "$input_image" \
        -fuzz "$FUZZ_PERCENT" \
        -transparent "$color_hex" \
        "$temp_dir/${filename_noext}_step1.png"; then
        echo "  Failed step 1 for $filename"
        ((failed++))
        rm -rf "$temp_dir"
        continue
    fi
    
    # METHOD 2: Alternative - Better for edges but slower
    # Uncomment the following block and comment METHOD 1 for better quality
    
    # # 2A. Create a mask of the color to remove
    # magick "$input_image" \
    #     -fill white -fuzz "$FUZZ_PERCENT" -opaque "$color_hex" \
    #     -fill black +opaque white \
    #     -alpha off \
    #     "$temp_dir/${filename_noext}_mask.png"
    # 
    # # 2B. Apply the mask
    # magick "$input_image" \
    #     "$temp_dir/${filename_noext}_mask.png" \
    #     -compose Copy_Opacity -composite \
    #     "$temp_dir/${filename_noext}_step1.png"
    
    # 3. Clean up semi-transparent pixels (optional)
    magick "$temp_dir/${filename_noext}_step1.png" \
        -channel A -threshold 10% +channel \
        "$temp_dir/${filename_noext}_clean.png"
    
    # 4. Final trim and save
    if ! magick "$temp_dir/${filename_noext}_clean.png" \
        -trim +repage \
        "$output_directory/$filename"; then
        echo "  Failed to save final image for $filename"
        ((failed++))
    else
        echo "  Successfully processed $filename"
        ((processed++))
    fi
    
    # Clean up temporary files
    rm -rf "$temp_dir"
done

# Summary
echo ""
echo "Processing complete!"
echo "Successfully processed: $processed images"
if [ $failed -gt 0 ]; then
    echo "Failed to process: $failed images"
fi
echo ""
echo "TIP: If results aren't perfect, adjust the FUZZ_PERCENT in the script."
echo "For solid colors: 5-10% | For gradients: 15-25% | For photos: 20-30%"