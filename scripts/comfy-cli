#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes
# Source: https://github.com/comfyanonymous/ComfyUI
# Tutorial: https://www.youtube.com/watch?v=TLE9NmN_sxw

py_venv="${HOME}/.python/comfyui-cli"
activate="${py_venv}/bin/activate"

# FunÃ§Ã£o para detectar arquitetura da GPU NVIDIA
get_cuda_version() {
    # Extrai a capability da GPU
    local capability; capability=$(nvidia-smi --query-gpu=compute_cap --format=csv,noheader | head -1)
    
    if [[ -z "$capability" ]]; then
        echo "cu130"  # Fallback padrÃ£o
        return
    fi
    
    # Remove o ponto (ex: 8.6 â†’ 86)
    local cap_int=$(echo "$capability" | tr -d '.')
    
    # Define versÃ£o CUDA baseada na capability
    if [[ $cap_int -ge 90 ]]; then  # 9.x+
        echo "cu130"  # CUDA 13.0 para GPUs muito novas
    elif [[ $cap_int -ge 86 ]]; then  # 8.6
        echo "cu130"  # CUDA 13.0
    elif [[ $cap_int -ge 80 ]]; then  # 8.0
        echo "cu130"  # CUDA 13.0
    elif [[ $cap_int -ge 75 ]]; then  # 7.5
        echo "cu121"  # CUDA 12.1
    elif [[ $cap_int -ge 70 ]]; then  # 7.0
        echo "cu121"  # CUDA 12.1
    elif [[ $cap_int -ge 61 ]]; then  # 6.1
        echo "cu118"  # CUDA 11.8
    else
        echo "cu118"  # Fallback para GPUs antigas
    fi
}

gpu_detect() {
    if lspci | grep -E "VGA|3D" | grep -i "NVIDIA" >/dev/null 2>&1; then
        echo "ðŸ” Detectada GPU NVIDIA"
        
        # Obter versÃ£o CUDA apropriada
        local cuda_version; cuda_version=$(get_cuda_version)
        echo "ðŸ“Š Arquitetura da GPU requer CUDA: $cuda_version"
        
        # Instalar PyTorch com versÃ£o CUDA correta
        case "$cuda_version" in
            "cu130")
                echo "â¬‡ï¸  Instalando PyTorch com CUDA 13.0"
                pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu130
                ;;
            "cu128")
                echo "â¬‡ï¸  Instalando PyTorch com CUDA 12.8"
                pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu128
                ;;
            "cu126")
                echo "â¬‡ï¸  Instalando PyTorch com CUDA 12.6"
                pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu126
                ;;
#             "cu121")
#                 echo "â¬‡ï¸  Instalando PyTorch com CUDA 12.1"
#                 pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu121
#                 ;;
#             "cu118")
#                 echo "â¬‡ï¸  Instalando PyTorch com CUDA 11.8"
#                 pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu118
#                 # Ative o ambiente virtual (se jÃ¡ nÃ£o estiver ativo)
# source ~/.python/comfyui-cli/bin/activate

# # Desinstale a versÃ£o incompatÃ­vel do PyTorch
# pip uninstall torch torchvision torchaudio -y

# # Instale o PyTorch compatÃ­vel com a GTX 1050 Ti (CUDA 12.6)
# pip install torch==2.9.0 torchvision==0.24.0 torchaudio==2.9.0 --index-url https://download.pytorch.org/whl/cu126
#                 ;;
            *)
                echo "âš ï¸  Usando CUDA 12.6 como fallback"
                pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu126
                ;;
        esac
        
    elif lspci | grep -E "VGA|3D" | grep -Ei "AMD|ATI" >/dev/null 2>&1; then
        echo "ðŸ” Detectada GPU AMD"
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/rocm6.4
        
    elif lspci | grep -E "VGA|3D" | grep -i "Intel" >/dev/null 2>&1; then
        echo "ðŸ” Detectada GPU Intel"
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/xpu
        
    else
        echo "âš ï¸  GPU nÃ£o detectada - instalando para CPU"
        pip install torch torchvision torchaudio
    fi
}

if [[ ! -d "$py_venv" ]]; then
    python -m venv "$py_venv"
    cd "$py_venv" || true
    wget https://raw.githubusercontent.com/comfyanonymous/ComfyUI/refs/heads/master/requirements.txt
    #shellcheck source=/dev/null
    source "$activate"
    export VIRTUAL_ENV="$py_venv"
    gpu_detect
    pip install -r requirements.txt
    pip install comfy-cli
fi

if [[ -z "$VIRTUAL_ENV" ]]; then
    export VIRTUAL_ENV="$py_venv"
    #shellcheck source=/dev/null
    source "$activate"
fi

if ! command -v comfy-cli >/dev/null; then
    pip install comfy-cli
fi

comfy-cli "$@"