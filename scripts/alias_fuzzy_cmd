#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes

: <<'DOCUMENTATION'
Script: ${0##*/} - Fuzzy finder para aliases de comandos shell.

✓ Substring case-insensitive search em aliases
✓ Real-time updating while typing/deleting
✓ Colorful and intuitive interface
✓ Navigation with arrow keys
✓ Direct execution with Enter
✓ Usage modes: interactive, initial search, simple list

Usage modes:
  ${0##*/}                     # Empty interactive interface
  ${0##*/} [term]              # Interface with initial search
  ${0##*/} --list, -l [term]   # Non-interactive list
  ${0##*/} --docs, -d          # Print this documentation
  ${0##*/} --history, -H       # Exibir histórico de comandos"
  ${0##*/} --help, -h          # Help

Examples:
  ${0##*/} snap                # Search for aliases with "snap"
  ${0##*/} --list fire         # List aliases with "fire"
DOCUMENTATION

# Colors for the interface
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Internationalization messages
declare -A MESSAGES

if [[ "${LANG,,}" =~ pt_ ]]; then
    # Portuguese messages
    MESSAGES=(
        [title]="=== Buscador Fuzzy de Aliases ==="
        [search]="Busca: "
        [aliases_found]="Aliases encontrados: "
        [instructions]="Use ↑↓ para navegar, Enter para executar, Backspace para editar, Ctrl+C para sair"
        [no_aliases]="Nenhum alias encontrado."
        [position]="[%d/%d]"
        [executing]="Alias selecionado: "
        [command]="Comando do alias: "
        [history_title]="Histórico de aliases executados:"
        [no_history]="Nenhum histórico disponível."
        [usage_title]="Uso: ${0##*/} [termo_de_busca]"
        [usage1]="     ${0##*/}                      - Interface interativa"
        [usage2]="     ${0##*/} [termo]              - Iniciar com termo de busca"
        [usage3]="     ${0##*/} --list, -l [termo]   - Listar aliases sem interface"
        [usage4]="     ${0##*/} --docs, -d           - Mostrar documentação"
        [usage5]="     ${0##*/} --history, -H        - Exibir histórico de aliases"
        [usage6]="     ${0##*/} --help, -h           - Mostrar esta ajuda"
        [loading_aliases]="Carregando aliases..."
    )
else
    # English messages (default)
    MESSAGES=(
        [title]="=== Aliases Fuzzy Finder ==="
        [search]="Search: "
        [aliases_found]="Aliases found: "
        [instructions]="Use ↑↓ to navigate, Enter to execute, Backspace to edit, Ctrl+C to exit"
        [no_aliases]="No aliases found."
        [position]="[%d/%d]"
        [executing]="Selected alias: "
        [command]="Alias command: "
        [history_title]="Executed aliases history:"
        [no_history]="No history available."
        [usage_title]="Usage: ${0##*/} [search_term]"
        [usage1]="     ${0##*/}                      - Interactive interface"
        [usage2]="     ${0##*/} [term]               - Start with search term"
        [usage3]="     ${0##*/} --list, -l [term]    - List aliases without interface"
        [usage4]="     ${0##*/} --docs, -d           - Show documentation"
        [usage5]="     ${0##*/} --history, -H        - Display aliases history"
        [usage6]="     ${0##*/} --help, -h           - Print this help"
        [loading_aliases]="Loading aliases..."
    )
fi

# Global variables
declare -a aliases
declare -A alias_commands  # Store full alias definitions
declare -a filtered_aliases
current_index=0
search_term=""

# Configuration
CONF_FILE="$HOME/.config/${0##*/}.conf"
ALIAS_DIRS=(
    "$HOME/.shell_utils/aliases/"
    "$HOME/.local/shell_utils/aliases/"
)

# Load configuration if exists
if [[ -f "$CONF_FILE" ]]; then
    source "$CONF_FILE"
fi

# Configuration defaults
MAX_RESULTS=35
SHOW_COUNT=10
HISTORY_FILE="$HOME/.${0##*/}_history"
HISTORY_MAX=1000

# Function to get all aliases from directories
get_all_aliases() {
    echo -e "${YELLOW}${MESSAGES[loading_aliases]}${NC}" >&2
    
    local -a alias_files
    local -A seen_aliases
    
    # Find all alias files in the directories
    for dir in "${ALIAS_DIRS[@]}"; do
        if [[ -d "$dir" ]]; then
            while IFS= read -r -d '' file; do
                alias_files+=("$file")
            done < <(find "$dir" -type f \( -name "*.sh" -o -name "*.bash" -o -name "*.zsh" -o -name "*alias*" \) -print0 2>/dev/null)
        fi
    done
    
    # If no alias files found in directories, try to find .bash_aliases, .zsh_aliases, etc.
    if [[ ${#alias_files[@]} -eq 0 ]]; then
        local user_alias_files=(
            "$HOME/.bash_aliases"
            "$HOME/.zsh_aliases"
            "$HOME/.aliases"
        )
        
        for file in "${user_alias_files[@]}"; do
            if [[ -f "$file" ]]; then
                alias_files+=("$file")
            fi
        done
    fi
    
    # Extract aliases from files
    for file in "${alias_files[@]}"; do
        # Skip if file doesn't exist or isn't readable
        [[ ! -r "$file" ]] && continue
        
        # Extract aliases using grep - capture the full line
        while IFS= read -r line; do
            # Remove leading 'alias ' keyword and whitespace
            local cleaned_line="${line#alias}"
            cleaned_line="${cleaned_line#"${cleaned_line%%[![:space:]]*}"}"  # Trim leading whitespace
            
            # Extract alias name (everything before '=')
            local alias_name="${cleaned_line%%=*}"
            alias_name="${alias_name%"${alias_name##*[![:space:]]}"}"  # Trim trailing whitespace
            
            # Only add if it's not empty and not already added
            if [[ -n "$alias_name" && -z "${seen_aliases["$alias_name"]}" ]]; then
                aliases+=("$alias_name")
                # Store the full alias definition
                alias_commands["$alias_name"]="$line"
                seen_aliases["$alias_name"]=1
            fi
        done < <(grep -h "^[[:space:]]*alias[[:space:]]" "$file" 2>/dev/null)
    done
    
    # Also get aliases from current shell
    if [[ -n "$BASH_VERSION" ]]; then
        while IFS= read -r line; do
            # Line format: alias name='value'
            local alias_name="${line%%=*}"
            alias_name="${alias_name#alias }"
            
            if [[ -n "$alias_name" && -z "${seen_aliases["$alias_name"]}" ]]; then
                aliases+=("$alias_name")
                alias_commands["$alias_name"]="$line"
                seen_aliases["$alias_name"]=1
            fi
        done < <(alias 2>/dev/null)
    fi
    
    # Sort aliases
    mapfile -t aliases < <(printf "%s\n" "${aliases[@]}" | sort -u)
    filtered_aliases=("${aliases[@]}")
}

add_to_history() {
    local cmd="$1"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    [[ ! -f "$HISTORY_FILE" ]] && touch "$HISTORY_FILE"
    
    # Remove existing entries for this command
    if grep -q "| $cmd$" "$HISTORY_FILE"; then
        grep -v "| $cmd$" "$HISTORY_FILE" > "${HISTORY_FILE}.tmp"
        mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE"
    fi
    
    # Add with timestamp
    echo "$timestamp | $cmd" >> "$HISTORY_FILE"
    
    # Limit size
    if [[ $(wc -l < "$HISTORY_FILE") -gt $HISTORY_MAX ]]; then
        tail -n "$HISTORY_MAX" "$HISTORY_FILE" > "${HISTORY_FILE}.tmp"
        mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE"
    fi
}

show_history() {
    if [[ -f "$HISTORY_FILE" ]]; then
        clear
        echo -e "${CYAN}${MESSAGES[history_title]}${NC}\n"
        cat "$HISTORY_FILE" | tail -30
    else
        echo "${MESSAGES[no_history]}"
    fi
}

# IMPROVED function for fuzzy matching (case-insensitive substring search)
fuzzy_match() {
    local pattern="$1"
    local string="$2"
    
    # If no pattern, return success
    [[ -z "$pattern" ]] && return 0
    
    local pattern_lower="${pattern,,}"
    local string_lower="${string,,}"
    
    # Check if pattern is contained in string (substring search)
    [[ "$string_lower" == *"$pattern_lower"* ]]
}

# Function to filter aliases based on search term
filter_aliases() {
    filtered_aliases=()
    
    if [[ -z "$search_term" ]]; then
        filtered_aliases=("${aliases[@]}")
        return
    fi
    
    for alias_name in "${aliases[@]}"; do
        if fuzzy_match "$search_term" "$alias_name"; then
            filtered_aliases+=("$alias_name")
        fi
    done
}

# Function to highlight search term in alias
highlight_match() {
    local alias_name="$1"
    local pattern="$2"
    
    if [[ -z "$pattern" ]]; then
        echo "$alias_name"
        return
    fi
    
    local pattern_lower="${pattern,,}"
    local alias_lower="${alias_name,,}"
    
    # Find pattern position
    local pos="${alias_lower%%$pattern_lower*}"
    local pos_len=${#pos}
    
    if [[ "$alias_lower" == *"$pattern_lower"* ]]; then
        local before="${alias_name:0:$pos_len}"
        local match="${alias_name:$pos_len:${#pattern}}"
        local after="${alias_name:$((pos_len + ${#pattern}))}"
        echo -e "${before}${BOLD}${GREEN}${match}${NC}${after}"
    else
        echo "$alias_name"
    fi
}

# Function to clear screen
clear_screen() {
    printf "\033[2J\033[H"
}

# Function to display interface
display_interface() {
    clear_screen
    
    # Title
    echo -e "${BOLD}${CYAN}${MESSAGES[title]}${NC}"
    echo -e "${YELLOW}${MESSAGES[search]}${BOLD}${search_term}${NC}\033[5m_\033[0m"
    echo -e "${BLUE}${MESSAGES[aliases_found]}${#filtered_aliases[@]}${NC}"
    echo -e "${MAGENTA}${MESSAGES[instructions]}${NC}"
    echo "----------------------------------------"
    
    # Calculate indices for display
    local start_index=$((current_index - SHOW_COUNT/2))
    [[ $start_index -lt 0 ]] && start_index=0
    
    local end_index=$((start_index + SHOW_COUNT))
    [[ $end_index -gt ${#filtered_aliases[@]} ]] && end_index=${#filtered_aliases[@]}
    
    # Adjust start_index if needed
    if [[ $((end_index - start_index)) -lt $SHOW_COUNT && $start_index -gt 0 ]]; then
        start_index=$((end_index - SHOW_COUNT))
        [[ $start_index -lt 0 ]] && start_index=0
    fi
    
    # Display aliases
    for ((i=start_index; i<end_index; i++)); do
        local alias_name="${filtered_aliases[$i]}"
        
        if [[ $i -eq $current_index ]]; then
            echo -e "${BOLD}${RED}❯ ${NC}$(highlight_match "$alias_name" "$search_term")"
        else
            echo -e "  $(highlight_match "$alias_name" "$search_term")"
        fi
    done
    
    # Additional information
    if [[ ${#filtered_aliases[@]} -eq 0 ]]; then
        echo -e "\n${YELLOW}${MESSAGES[no_aliases]}${NC}"
    else
        printf "\n${BLUE}${MESSAGES[position]}${NC}\n" "$((current_index + 1))" "${#filtered_aliases[@]}"
    fi
}

# Main fuzzy finder function
run_fuzzy_finder() {
    get_all_aliases
    
    # If received an argument, use as initial term
    if [[ -n "$1" ]]; then
        search_term="$1"
        filter_aliases
    fi
    
    # Set up terminal for key reading
    local old_stty
    old_stty=$(stty -g)
    stty -icanon -echo min 1 time 0
    
    # Trap to restore terminal settings
    trap 'stty "$old_stty"; exit 0' INT TERM EXIT
    
    while true; do
        display_interface
        
        # Read character by character
        local char
        IFS= read -r -n1 char
        
        # Detect escape sequences (special keys)
        if [[ "$char" == $'\x1b' ]]; then
            # Read next 2 characters for escape sequences
            local seq1 seq2
            read -r -n1 -t 0.01 seq1
            read -r -n1 -t 0.01 seq2
            
            if [[ "$seq1" == '[' ]]; then
                case "$seq2" in
                    'A') # Up arrow
                        if [[ $current_index -gt 0 ]]; then
                            ((current_index--))
                        fi
                        ;;
                    'B') # Down arrow
                        if [[ $current_index -lt $((${#filtered_aliases[@]} - 1)) ]]; then
                            ((current_index++))
                        fi
                        ;;
                    'H') # Home
                        current_index=0
                        ;;
                    'F') # End
                        current_index=$((${#filtered_aliases[@]} - 1))
                        [[ $current_index -lt 0 ]] && current_index=0
                        ;;
                esac
            fi
        elif [[ "$char" == $'\x7f' || "$char" == $'\x08' ]]; then
            # Backspace or Delete
            if [[ ${#search_term} -gt 0 ]]; then
                search_term="${search_term:0:$((${#search_term}-1))}"
                filter_aliases
                current_index=0
            fi
        elif [[ "$char" == $'\x0a' || "$char" == $'\x0d' || "$char" == '' ]]; then
            # Enter (Line Feed or Carriage Return or empty)
            if [[ ${#filtered_aliases[@]} -gt 0 && $current_index -ge 0 ]]; then
                local selected_alias="${filtered_aliases[$current_index]}"
                stty "$old_stty"
                clear_screen
                
                # Show selected alias and its full command
                echo -e "${GREEN}${MESSAGES[executing]}${BOLD}${selected_alias}${NC}"
                echo -e "${CYAN}${MESSAGES[command]}${BOLD}${alias_commands[$selected_alias]}${NC}\n"
                
                add_to_history "$selected_alias"
                
                # Show alias definition from shell
                #type -a "$selected_alias" 2>/dev/null || echo "${alias_commands[$selected_alias]}"
                exit 0
            fi
        elif [[ "$char" == $'\x03' ]]; then
            # Ctrl+C
            stty "$old_stty"
            clear_screen
            exit 0
        elif [[ -n "$char" && "$char" =~ [[:print:]] ]]; then
            # Normal printable characters
            search_term+="$char"
            filter_aliases
            current_index=0
        fi
    done
}

# Function for simple search mode (without interactive interface)
simple_search() {
    get_all_aliases
    local search="$1"
    
    for alias_name in "${aliases[@]}"; do
        if fuzzy_match "$search" "$alias_name"; then
            echo "$alias_name"
        fi
    done | head -$MAX_RESULTS
}

# Main entry point
main() {
    # Check if in an interactive terminal
    if [[ -t 0 && -t 1 ]]; then
        # Interactive mode
        if [[ "$1" == "--history" || "$1" == "-H" ]]; then
            show_history
        elif [[ "$1" == "--docs" || "$1" == "-d" ]]; then
            sed -n '/^: <<.DOCUMENTATION./,/^DOCUMENTATION/p' "$0" | sed '1d;$d'
            exit 0
        elif [[ "$1" == "--help" || "$1" == "-h" ]]; then
            echo "${MESSAGES[usage_title]}"
            echo "${MESSAGES[usage1]}"
            echo "${MESSAGES[usage2]}"
            echo "${MESSAGES[usage3]}"
            echo "${MESSAGES[usage4]}"
            echo "${MESSAGES[usage5]}"
            echo "${MESSAGES[usage6]}"
            exit 0
        elif [[ "$1" == "--list" || "$1" == "-l" ]]; then
            # Simple list mode
            simple_search "${2:-}"
            exit 0
        else
            # Interactive fuzzy finder mode
            run_fuzzy_finder "${1:-}"
        fi
    else
        # Non-interactive mode (pipe, etc)
        simple_search "${1:-}"
    fi
}

# Execute
main "$@"