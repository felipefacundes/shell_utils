#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes

: <<'DOCUMENTATION'
help_shell - Dynamic Function Help System for Bash

DESCRIPTION:
Imagine creating helper functions and typing whatever you want in the terminal, just creating a 
simple function instead of an entire script—this is the premise of help_shell.

The help_shell script is an efficient and user-friendly tool designed to dynamically 
display help information for your Bash functions.

FEATURES:
- Dynamic Help Display: Automatically lists all available functions with descriptions extracted from comments.
- Interactive Search: Search for functions by name or description using a clean and intuitive menu powered by whiptail.
- Flexible Usage: Allows for specifying functions as command-line arguments or interacting via the dynamic menu.
- Integration Ready: Seamlessly integrates with the shell_utils framework, leveraging pre-defined variables and resources.

USAGE:
  help_shell                    # Interactive mode with search menu
  help_shell function_name      # Execute specific function directly
  help_shell func1 func2 ...    # Execute multiple functions
  help_shell -h | --help        # Display this help message
  help_shell search_term        # Search and select functions matching term

EXAMPLES:
  help_shell                    # Launch interactive function browser
  help_shell git_status         # Execute git_status function directly
  help_shell backup cleanup     # Execute backup then cleanup functions
  help_shell -h                 # Show detailed help documentation
  help_shell "docker"           # Search for functions related to docker

FUNCTION DOCUMENTATION FORMAT:
To ensure your functions are properly documented, use this format:

# Function description that will appear in help

✅ CORRECT - Description will be detected:
my_function() {
    echo "# This description WILL be detected"
    echo "Doing actual work..."
}

❌ INCORRECT - Regular comments won't work:
my_function() {
    # This comment WON'T be detected
    echo "Doing work..."
}

Best example:

remove_extension() {
cat <<'EOF'
# Remove extension

Examples:

SCRIPT_NAME="${0##*/}"

filename="file.backup.tar.gz"
echo "${filename%.*}"     # Output: file.backup.tar
echo "${filename%%.*}"    # Output: file
echo "${filename##*.}"    # Output: gz
EOF
}
DOCUMENTATION

shell_utils=~/.shell_utils
help_dir="${shell_utils}/scripts/helps"
help_user_dir="${HOME}/.local/shell_utils/scripts/helps"

shopt -s globstar
source "${shell_utils}/variables/shell_colors.sh"

help_directories=("$help_dir" "$help_user_dir")

for dir in "${help_directories[@]}"; do
    for file in "${dir}"/**/*.sh; do
        [[ -f "$file" ]] && source "${file}"
    done
done

show_documentation() {
    awk '
    BEGIN { inside_block = 0 }

    # Check the beginning of the DOCUMENTATION block
    /: <<'\''DOCUMENTATION'\''/ { inside_block = 1; next }

    # Check the end of the DOCUMENTATION block
    inside_block && $0 == "DOCUMENTATION" { inside_block = 0; exit }

    # Print lines within the DOCUMENTATION block
    inside_block { print }
    ' "$0"
}

# Display help dynamically
help() {
    show_documentation
            
    echo -e "\nINTERACTIVE USAGE:"
    echo "  • Leave search term blank to list all functions"
    echo "  • Use arrow keys to navigate the menu"
    echo "  • Press Enter to execute selected function"
    echo "  • Press Esc or Cancel to exit"
    echo -e "\nEnter 'q' to quit this help.\n"
}

# Function to search and display functions matching a term
search_and_select_function() {
    local search_term="$1"
    
    # Normalize the search term to lowercase
    search_term=$(echo "$search_term" | tr '[:upper:]' '[:lower:]')

    # Initialize an empty array to hold the menu items
    menu_items=()

    for func_name in $(declare -F | cut -d " " -f 3); do
        # Extract the first comment line of the function
        description=$(type "$func_name" | grep -m 1 '^#')
        # Remove the '#' character from the description
        description=${description/#\# /}
        
        # Normalize function name and description to lowercase
        func_name_lower=$(echo "$func_name" | tr '[:upper:]' '[:lower:]')
        description_lower=$(echo "$description" | tr '[:upper:]' '[:lower:]')

        # If the function name or description matches the search term, add it to the menu items
        if [[ -z "$search_term" || "$func_name_lower" == *"$search_term"* || "$description_lower" == *"$search_term"* ]]; then
            menu_items+=("$func_name" "| $description")
        fi
    done

    # Check if no items were found
    if [[ ${#menu_items[@]} -eq 0 ]]; then
        whiptail --msgbox "No matches found for '$search_term'. Please try again." 8 78
        return 1
    fi

    # Pass the menu items to whiptail and get the selected item
    selected_item=$(whiptail --title "Functions menu" --menu "Choose a function" 24 80 17 "${menu_items[@]}" 3>&1 1>&2 2>&3)

    # If the user pressed Cancel, return
    if [[ $? -ne 0 ]]; then
        return 1
    fi

    # Check if the selected item is a function
    if declare -f "$selected_item" > /dev/null; then
        clear
        # Call the function
        "$selected_item"
        return 0
    else
        echo "Function '$selected_item' not found."
        return 1
    fi
}

# Check if help option was provided
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    help | less -i -R
    exit 0
fi

if [[ -z "$1" ]]; then
    while true; do
        # Ask the user for a search term
        search_term=$(whiptail --inputbox "Enter a search term (leave blank to list all functions):" 8 78 3>&1 1>&2 2>&3)

        # If the user pressed Cancel, break the loop
        if [[ $? -ne 0 ]]; then
            break
        fi

        # Use the search function
        if search_and_select_function "$search_term"; then
            break
        fi
    done
    exit 0
fi

# Iterate over the passed arguments
for func_name in "$@"; do
    # Check if the function exists
    if declare -f "$func_name" > /dev/null; then
        # Call the function
        shift
        "$func_name" "$@"
    else
        echo "Function '$func_name' not found. Searching for similar functions..."
        # If function not found, search for similar functions
        if ! search_and_select_function "$func_name"; then
            echo "No similar functions found for '$func_name'."
        fi
        break
    fi
done