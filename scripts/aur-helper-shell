#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes

: <<'DOCUMENTATION'
Script: aur_helper_in_shell
Description: Search and install packages from AUR on Arch Linux
Usage: ./aur-helper-shell <options> <term>
DOCUMENTATION

SCRIPT=${0##*/}
SCRIPT_REAL_NAME="${SCRIPT%%.*}"
CACHE=~/.cache/$SCRIPT_REAL_NAME

# Configurations
AUR_API_URL="https://aur.archlinux.org/rpc/?v=5&type=search&arg="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Language support
declare -A MESSAGES

if [[ "${LANG,,}" =~ pt_ ]]; then
    # Portuguese messages
    MESSAGES=(
        ["warning_no_curl_wget"]="Aviso: Nem curl nem wget foram encontrados."
        ["installing_curl"]="Instalando curl..."
        ["please_install_curl"]="Por favor, instale curl ou wget manualmente."
        ["searching_for"]="Pesquisando por:"
        ["error_cannot_connect"]="Erro: Não foi possível conectar ao AUR."
        ["no_packages_found"]="Nenhum pacote encontrado para:"
        ["found_packages"]="Encontrados %s pacotes"
        ["showing_all_results"]="Mostrando TODOS os resultados:"
        ["showing_results"]="Mostrando %s resultados:"
        ["tips"]="Dicas:"
        ["install_aur_package"]="1. Para instalar um pacote do AUR, use um helper como:"
        ["yay_recommended"]="   - yay (recomendado)"
        ["paru"]="   - paru"
        ["aura"]="   - aura"
        ["example_yay"]="2. Exemplo com yay: yay -S nome-do-pacote"
        ["installed"]="✓ instalado"
        ["available"]="○ disponível nos repositórios"
        ["not_installed"]="✗ não instalado"
        ["details_of_results"]="Detalhes dos %s resultados:"
        ["result"]="Resultado %s:"
        ["description"]="Descrição:"
        ["version"]="Versão:"
        ["votes"]="Votos:"
        ["popularity"]="Popularidade:"
        ["maintainer"]="Mantenedor:"
        ["status_outdated"]="Status: Fora de data"
        ["status_updated"]="Status: Atualizado"
        ["installed_status"]="Instalado:"
        ["save_results"]="Deseja salvar os resultados em um arquivo? (s/n):"
        ["results_saved"]="Resultados salvos em:"
        ["processing_installation"]="Processando instalação de:"
        ["package_exists_cache"]="O pacote já existe no diretório:"
        ["remove_and_generate"]="Deseja remover e gerar um novo pacote? (s/n):"
        ["removing_existing_dir"]="Removendo diretório existente..."
        ["directory_removed"]="Diretório removido."
        ["using_existing_package"]="Usando pacote existente no diretório."
        ["cloning_aur_repo"]="Clonando repositório do AUR..."
        ["ssh_clone_success"]="Clone via SSH bem-sucedido!"
        ["ssh_failed_trying_https"]="Falha no clone SSH, tentando HTTPS..."
        ["https_clone_success"]="Clone via HTTPS bem-sucedido!"
        ["error_cannot_clone"]="Erro: Não foi possível clonar o repositório."
        ["check_package_name"]="Verifique se o nome do pacote está correto: %s"
        ["edit_pkgbuild"]="Deseja editar o PKGBUILD? (s/n):"
        ["no_editor_found"]="Nenhum editor encontrado!"
        ["set_editor"]="Por favor, defina um editor no seu arquivo de configuração do shell:"
        ["export_editor"]="  export EDITOR=seu_editor_favorito"
        ["add_to_config"]="Adicione essa linha no ~/.bashrc ou ~/.zshrc"
        ["available_editors"]="Editores disponíveis: neovim, vim, nano, vi"
        ["opening_pkgbuild"]="Abrindo PKGBUILD com %s..."
        ["build_options"]="Opções de construção:"
        ["generate_only"]="1. Gerar pacote apenas (makepkg -s)"
        ["generate_and_install"]="2. Gerar e instalar (makepkg -si)"
        ["generate_force_install"]="3. Gerar, forçar e instalar (makepkg -sfi)"
        ["choose_option"]="Escolha uma opção (1/2/3):"
        ["generating_package"]="Gerando pacote..."
        ["generating_installing"]="Gerando e instalando pacote..."
        ["generating_force_installing"]="Gerando, forçando e instalando pacote..."
        ["invalid_option"]="Opção inválida. Saindo."
        ["process_completed"]="Processo concluído!"
        ["build_failed"]="O processo não conseguiu construir o pacote."
        ["package_location"]="O pacote está em: %s"
        ["see_detailed_info"]="Deseja ver informações detalhadas dos primeiros pacotes? (s/n):"
        ["error_no_search_term"]="Erro: Nenhum termo de pesquisa fornecido."
        ["usage_search"]="Uso: %s -s <termo-de-pesquisa> [full|número]"
        ["error_no_package_name"]="Erro: Nome do pacote não fornecido."
        ["usage_install"]="Uso: %s -i <nome-do-pacote>"
        ["usage_info"]="Uso: %s --info <nome-do-pacote>"
        ["example_info"]="Exemplo: %s --info neovim"
        ["usage_remove"]="Uso: %s -R, --remove <nome-do-pacote>"
        ["example_remove"]="Exemplo: %s -R neovim"
        ["usage_remove_all"]="Uso: %s -Rcs, --remove-all <nome-do-pacote>"
        ["example_remove_all"]="Exemplo: %s -Rcs neovim"
        ["warning_arg_ignored"]="Aviso: Argumento '%s' ignorado. Pesquisando apenas por '%s'"
        ["error_no_curl_wget"]="Erro: curl ou wget não estão disponíveis."
        ["script_title"]="AUR Helper in Shell"
        ["script_description"]="Script para pesquisar e instalar pacotes no Arch User Repository (AUR)"
        ["usage"]="Uso:"
        ["default_search"]="  %s <termo-de-pesquisa>                   - Pesquisa pacotes no AUR (padrão: 20 resultados)"
        ["search_with_limit"]="  %s <termo-de-pesquisa> <full|número>     - Pesquisa com limite personalizado"
        ["search_option"]="  %s -s, --search <termo>                  - Pesquisa pacotes no AUR (padrão: 20 resultados)"
        ["search_option_limit"]="  %s -s <termo> <full|número>              - Pesquisa com limite personalizado"
        ["detailed_option"]="  %s -d, --detailed <termo>                - Pesquisa com detalhes (padrão: 5 resultados)"
        ["detailed_option_limit"]="  %s -d <termo> <full|número>              - Pesquisa detalhada com limite personalizado"
        ["install_option"]="  %s -i, --install <nome-do-pacote>        - Instala um pacote do AUR"
        ["info_option"]="  %s -Qi, --info, --query-info <pacote>    - Mostra informações detalhadas do pacote instalado"
        ["remove_option"]="  %s -R, --remove <nome-do-pacote>         - Remove um pacote instalado"
        ["remove_all_option"]="  %s -Rcs, --remove-all, --purge <pacote>  - Remove um pacote e suas dependências"
        ["help_option"]="  %s -h, --help                            - Mostra esta ajuda"
        ["examples"]="Exemplos:"
        ["example1"]="  %s neovim"
        ["example2"]="  %s neovim 30                             # Mostra até 30 resultados"
        ["example3"]="  %s neovim full                           # Mostra todos os resultados"
        ["example4"]="  %s --search visual-studio-code"
        ["example5"]="  %s -s neovim full                        # Mostra todos os pacotes relacionados a neovim"
        ["example6"]="  %s -s neovim 50                          # Mostra até 50 pacotes"
        ["example7"]="  %s -d neovim                             # Mostra detalhes dos 5 primeiros"
        ["example8"]="  %s -d neovim full                        # Mostra detalhes de TODOS os pacotes"
        ["example9"]="  %s -d neovim 15                          # Mostra detalhes de 15 pacotes"
        ["example10"]="  %s --install yay"
        ["example11"]="  %s -i google-chrome"
        ["example12"]="  %s --info neovim                         # Mostra informações do neovim instalado"
        ["example13"]="  %s -Qi neovim                            # Mostra informações do neovim instalado"
        ["example14"]="  %s -R neovim                             # Remove o neovim instalado"
        ["example15"]="  %s --remove-all neovim                   # Remove neovim e suas dependências"
        ["dependencies"]="Dependências:"
        ["deps_curl_wget"]="  - curl ou wget (será instalado automaticamente se necessário)"
        ["deps_git"]="  - git (para clonar repositórios)"
        ["deps_makepkg"]="  - makepkg (para construir pacotes)"
        ["cache"]="Cache:"
        ["cache_location"]="  Os pacotes serão baixados em: ~/.cache/%s/"
        ["search_format"]="Formato da pesquisa:"
        ["format_description"]="  nome_do_pacote versão descrição"
    )
else
    # English messages (default)
    MESSAGES=(
        ["warning_no_curl_wget"]="Warning: Neither curl nor wget were found."
        ["installing_curl"]="Installing curl..."
        ["please_install_curl"]="Please install curl or wget manually."
        ["searching_for"]="Searching for:"
        ["error_cannot_connect"]="Error: Could not connect to AUR."
        ["no_packages_found"]="No packages found for:"
        ["found_packages"]="Found %s packages"
        ["showing_all_results"]="Showing ALL results:"
        ["showing_results"]="Showing %s results:"
        ["tips"]="Tips:"
        ["install_aur_package"]="1. To install an AUR package, use a helper like:"
        ["yay_recommended"]="   - yay (recommended)"
        ["paru"]="   - paru"
        ["aura"]="   - aura"
        ["example_yay"]="2. Example with yay: yay -S package-name"
        ["installed"]="✓ installed"
        ["available"]="○ available in repositories"
        ["not_installed"]="✗ not installed"
        ["details_of_results"]="Details of %s results:"
        ["result"]="Result %s:"
        ["description"]="Description:"
        ["version"]="Version:"
        ["votes"]="Votes:"
        ["popularity"]="Popularity:"
        ["maintainer"]="Maintainer:"
        ["status_outdated"]="Status: Out of date"
        ["status_updated"]="Status: Updated"
        ["installed_status"]="Installed:"
        ["save_results"]="Do you want to save the results to a file? (y/n):"
        ["results_saved"]="Results saved in:"
        ["processing_installation"]="Processing installation of:"
        ["package_exists_cache"]="Package already exists in directory:"
        ["remove_and_generate"]="Do you want to remove and generate a new package? (y/n):"
        ["removing_existing_dir"]="Removing existing directory..."
        ["directory_removed"]="Directory removed."
        ["using_existing_package"]="Using existing package in directory."
        ["cloning_aur_repo"]="Cloning AUR repository..."
        ["ssh_clone_success"]="SSH clone successful!"
        ["ssh_failed_trying_https"]="SSH clone failed, trying HTTPS..."
        ["https_clone_success"]="HTTPS clone successful!"
        ["error_cannot_clone"]="Error: Could not clone repository."
        ["check_package_name"]="Check if package name is correct: %s"
        ["edit_pkgbuild"]="Do you want to edit PKGBUILD? (y/n):"
        ["no_editor_found"]="No editor found!"
        ["set_editor"]="Please define an editor in your shell configuration file:"
        ["export_editor"]="  export EDITOR=your_favorite_editor"
        ["add_to_config"]="Add this line to ~/.bashrc or ~/.zshrc"
        ["available_editors"]="Available editors: neovim, vim, nano, vi"
        ["opening_pkgbuild"]="Opening PKGBUILD with %s..."
        ["build_options"]="Build options:"
        ["generate_only"]="1. Generate package only (makepkg -s)"
        ["generate_and_install"]="2. Generate and install (makepkg -si)"
        ["generate_force_install"]="3. Generate, force and install (makepkg -sfi)"
        ["choose_option"]="Choose an option (1/2/3):"
        ["generating_package"]="Generating package..."
        ["generating_installing"]="Generating and installing package..."
        ["generating_force_installing"]="Generating, forcing and installing package..."
        ["invalid_option"]="Invalid option. Exiting."
        ["process_completed"]="Process completed!"
        ["build_failed"]="The process failed to build the package"
        ["package_location"]="Package is located at: %s"
        ["see_detailed_info"]="Do you want to see detailed information of first packages? (y/n):"
        ["error_no_search_term"]="Error: No search term provided."
        ["usage_search"]="Usage: %s -s <search-term> [full|number]"
        ["error_no_package_name"]="Error: No package name provided."
        ["usage_install"]="Usage: %s -i <package-name>"
        ["usage_info"]="Usage: %s --info <package-name>"
        ["example_info"]="Example: %s --info neovim"
        ["usage_remove"]="Usage: %s -R, --remove <package-name>"
        ["example_remove"]="Example: %s -R neovim"
        ["usage_remove_all"]="Usage: %s -Rcs, --remove-all <package-name>"
        ["example_remove_all"]="Example: %s -Rcs neovim"
        ["warning_arg_ignored"]="Warning: Argument '%s' ignored. Searching only for '%s'"
        ["error_no_curl_wget"]="Error: curl or wget are not available."
        ["script_title"]="AUR Helper in Shell"
        ["script_description"]="Script to search and install packages from Arch User Repository (AUR)"
        ["usage"]="Usage:"
        ["default_search"]="  %s <search-term>                   - Search packages in AUR (default: 20 results)"
        ["search_with_limit"]="  %s <search-term> <full|number>     - Search with custom limit"
        ["search_option"]="  %s -s, --search <term>                  - Search packages in AUR (default: 20 results)"
        ["search_option_limit"]="  %s -s <term> <full|number>              - Search with custom limit"
        ["detailed_option"]="  %s -d, --detailed <term>                - Search with details (default: 5 results)"
        ["detailed_option_limit"]="  %s -d <term> <full|number>              - Detailed search with custom limit"
        ["install_option"]="  %s -i, --install <package-name>        - Install an AUR package"
        ["info_option"]="  %s -Qi, --info, --query-info <package>    - Show detailed information of installed package"
        ["remove_option"]="  %s -R, --remove <package-name>         - Remove an installed package"
        ["remove_all_option"]="  %s -Rcs, --remove-all, --purge <package>  - Remove a package and its dependencies"
        ["help_option"]="  %s -h, --help                            - Show this help"
        ["examples"]="Examples:"
        ["example1"]="  %s neovim"
        ["example2"]="  %s neovim 30                             # Show up to 30 results"
        ["example3"]="  %s neovim full                           # Show all results"
        ["example4"]="  %s --search visual-studio-code"
        ["example5"]="  %s -s neovim full                        # Show all packages related to neovim"
        ["example6"]="  %s -s neovim 50                          # Show up to 50 packages"
        ["example7"]="  %s -d neovim                             # Show details of first 5 packages"
        ["example8"]="  %s -d neovim full                        # Show details of ALL packages"
        ["example9"]="  %s -d neovim 15                          # Show details of 15 packages"
        ["example10"]="  %s --install yay"
        ["example11"]="  %s -i google-chrome"
        ["example12"]="  %s --info neovim                         # Show information of installed neovim"
        ["example13"]="  %s -Qi neovim                            # Show information of installed neovim"
        ["example14"]="  %s -R neovim                             # Remove installed neovim"
        ["example15"]="  %s --remove-all neovim                   # Remove neovim and its dependencies"
        ["dependencies"]="Dependencies:"
        ["deps_curl_wget"]="  - curl or wget (will be installed automatically if needed)"
        ["deps_git"]="  - git (to clone repositories)"
        ["deps_makepkg"]="  - makepkg (to build packages)"
        ["cache"]="Cache:"
        ["cache_location"]="  Packages will be downloaded in: ~/.cache/%s/"
        ["search_format"]="Search format:"
        ["format_description"]="  package_name version description"
    )
fi

# Function to install necessary dependencies
check_dependencies() {
    if ! command -v curl &> /dev/null && ! command -v wget &> /dev/null; then
        echo -e "${YELLOW}${MESSAGES["warning_no_curl_wget"]}${NC}"
        echo "${MESSAGES["installing_curl"]}"
        
        if command -v pacman &> /dev/null; then
            sudo pacman -S --needed curl
        elif command -v apt &> /dev/null; then
            sudo apt install curl
        else
            echo "${MESSAGES["please_install_curl"]}"
            exit 1
        fi
    fi
}

# Function to perform search
search_aur() {
    local search_term="$1"
    local limit="${2:-20}"
    
    echo -e "${BLUE}${MESSAGES["searching_for"]}${NC} ${GREEN}$search_term${NC}"
    echo "========================================"
    
    # Try curl first, then wget
    if command -v curl &> /dev/null; then
        response=$(curl -s "${AUR_API_URL}$search_term")
    elif command -v wget &> /dev/null; then
        response=$(wget -qO- "${AUR_API_URL}$search_term")
    else
        echo -e "${RED}${MESSAGES["error_no_curl_wget"]}${NC}"
        exit 1
    fi
    
    # Check if response is empty
    if [ -z "$response" ]; then
        echo -e "${RED}${MESSAGES["error_cannot_connect"]}${NC}"
        exit 1
    fi
    
    # Extract results
    result_count=$(echo "$response" | grep -o '"resultcount":[0-9]*' | cut -d: -f2)
    
    if [ "$result_count" -eq 0 ]; then
        echo -e "${YELLOW}${MESSAGES["no_packages_found"]} $search_term${NC}"
        exit 0
    fi
    
    # Set limit based on parameter
    if [ "$limit" = "full" ]; then
        display_limit="$result_count"
        echo -e "${GREEN}$(printf "${MESSAGES["found_packages"]}%s\n" "$result_count")${NC}"
        echo -e "${BLUE}${MESSAGES["showing_all_results"]}${NC}"
    else
        if [ "$limit" -gt "$result_count" ]; then
            display_limit="$result_count"
        else
            display_limit="$limit"
        fi
        echo -e "${GREEN}$(printf "${MESSAGES["found_packages"]}%s\n" "$result_count")${NC}"
        echo -e "${BLUE}$(printf "${MESSAGES["showing_results"]}%s\n" "$display_limit")${NC}"
    fi
    
    echo ""
    
    # Extract and sort data correctly using a simpler method
    # Extract names, versions and descriptions separately and then combine
    names=$(echo "$response" | grep -o '"Name":"[^"]*"' | cut -d'"' -f4)
    versions=$(echo "$response" | grep -o '"Version":"[^"]*"' | cut -d'"' -f4)
    descriptions=$(echo "$response" | grep -o '"Description":"[^"]*"' | cut -d'"' -f4)
    
    # Combine results line by line
    paste -d' ' <(echo "$names") <(echo "$versions") <(echo "$descriptions") | head -n "$display_limit" | \
    awk '{
        # Format output with fixed widths
        printf "%-35s %-20s %s\n", $1, $2, substr($0, index($0,$3))
    }'
    
    echo ""
    echo "========================================"
    echo -e "${BLUE}${MESSAGES["tips"]}${NC}"
    echo "${MESSAGES["install_aur_package"]}"
    echo "${MESSAGES["yay_recommended"]}"
    echo "${MESSAGES["paru"]}"
    echo "${MESSAGES["aura"]}"
    echo ""
    echo "${MESSAGES["example_yay"]}"
}

_is_installed() {
    local pkg="$1"
    
    if pacman -Qi "$pkg" &>/dev/null; then
        local version; version=$(LANG=c pacman -Qi "$pkg" | grep -i 'version' | head -1 | cut -d: -f2-5 | xargs)
        echo -e "${GREEN}${MESSAGES["installed"]}${NC} (v${version})"
    else
        if pacman -Si "$pkg" &>/dev/null; then
            echo -e "${YELLOW}${MESSAGES["available"]}${NC}"
        else
            echo -e "${RED}${MESSAGES["not_installed"]}${NC}"
        fi
    fi
}

# Function for detailed search (optional)
detailed_search() {
    local response="$1"
    local limit="${2:-5}"
    
    # Set limit based on parameter
    if [ "$limit" = "full" ]; then
        detail_limit=$(echo "$response" | grep -o '"Name":"[^"]*"' | wc -l)
    else
        detail_limit="$limit"
    fi
    
    echo ""
    echo -e "${BLUE}$(printf "${MESSAGES["details_of_results"]}%s\n" "$detail_limit")${NC}"
    echo "========================================"
    
    # Extract package names
    package_names=$(echo "$response" | grep -o '"Name":"[^"]*"' | cut -d'"' -f4 | head -n "$detail_limit")
    
    count=1
    for pkg in $package_names; do
        detail_url="https://aur.archlinux.org/rpc/?v=5&type=info&arg=$pkg"
        
        if command -v curl &> /dev/null; then
            pkg_info=$(curl -s "$detail_url")
        else
            pkg_info=$(wget -qO- "$detail_url")
        fi
        
        echo ""
        echo -e "${GREEN}$(printf "${MESSAGES["result"]}%s\n" "$count")${NC} $pkg"
        
        # Extract specific information
        description=$(echo "$pkg_info" | grep -o '"Description":"[^"]*"' | cut -d'"' -f4)
        version=$(echo "$pkg_info" | grep -o '"Version":"[^"]*"' | cut -d'"' -f4)
        votes=$(echo "$pkg_info" | grep -o '"NumVotes":[0-9]*' | cut -d: -f2)
        popularity=$(echo "$pkg_info" | grep -o '"Popularity":[0-9.]*' | cut -d: -f2)
        maintainer=$(echo "$pkg_info" | grep -o '"Maintainer":"[^"]*"' | cut -d'"' -f4)
        outofdate=$(echo "$pkg_info" | grep -o '"OutOfDate":[0-9]*' | cut -d: -f2)
        installed=$(_is_installed "$pkg")
        
        echo "  ${MESSAGES["description"]} $description"
        echo "  ${MESSAGES["version"]} $version"
        echo "  ${MESSAGES["votes"]} $votes"
        echo "  ${MESSAGES["popularity"]} $popularity"
        echo "  ${MESSAGES["maintainer"]} $maintainer"
        if [ -n "$outofdate" ] && [ "$outofdate" -gt 0 ]; then
            echo -e "  ${RED}${MESSAGES["status_outdated"]}${NC}"
        else
            echo -e "  ${GREEN}${MESSAGES["status_updated"]}${NC}"
        fi
        echo "  ${MESSAGES["installed_status"]} $installed"
        echo "  URL: https://aur.archlinux.org/packages/$pkg"
        
        count=$((count + 1))
    done
}

# Function to save results to file
save_results() {
    local response="$1"
    echo ""
    read -rp "${MESSAGES["save_results"]} " choice
    
    if [[ $choice =~ ^[SsYy]$ ]]; then
        filename="aur_results_$(date +%Y%m%d_%H%M%S).txt"
        
        # Extract all formatted results
        names=$(echo "$response" | grep -o '"Name":"[^"]*"' | cut -d'"' -f4)
        versions=$(echo "$response" | grep -o '"Version":"[^"]*"' | cut -d'"' -f4)
        descriptions=$(echo "$response" | grep -o '"Description":"[^"]*"' | cut -d'"' -f4)
        
        # Combine and format results
        paste -d' ' <(echo "$names") <(echo "$versions") <(echo "$descriptions") | \
        awk '{print "Nome: " $1 "\tVersão: " $2 "\tDescrição: " substr($0, index($0,$3))}' > "$filename"
        
        echo -e "${GREEN}${MESSAGES["results_saved"]}${NC} $filename"
    fi
}

f_makepkg() {
    local arg="$1"

    if makepkg "$arg"; then
        echo -e "${GREEN}${MESSAGES["process_completed"]}${NC}"
        printf "${MESSAGES["package_location"]}%s\n" "$CACHE/$package_name"
    else
        echo -e "${RED}${MESSAGES["build_failed"]}${NC}"
        printf "${MESSAGES["package_location"]}%s\n" "$CACHE/$package_name"
    fi
}

# Function to install package
install_package() {
    local package_name="$1"
    
    # Create cache directory if it doesn't exist
    mkdir -p "$CACHE"
    
    echo -e "${BLUE}${MESSAGES["processing_installation"]}${NC} ${GREEN}$package_name${NC}"
    echo "========================================"
    
    # Check if package already exists in cache
    if [ -d "$CACHE/$package_name" ]; then
        echo -e "${YELLOW}${MESSAGES["package_exists_cache"]}${NC}"
        echo "  $CACHE/$package_name"
        
        read -rp "${MESSAGES["remove_and_generate"]} " remove_choice
        
        if [[ $remove_choice =~ ^[SsYy]$ ]]; then
            echo -e "${YELLOW}${MESSAGES["removing_existing_dir"]}${NC}"
            rm -rf "${CACHE:?}/${package_name:?}"
            echo -e "${GREEN}${MESSAGES["directory_removed"]}${NC}"
        else
            echo -e "${YELLOW}${MESSAGES["using_existing_package"]}${NC}"
        fi
    fi
    
    # Clone repository if directory doesn't exist
    if [ ! -d "$CACHE/$package_name" ]; then
        echo -e "${BLUE}${MESSAGES["cloning_aur_repo"]}${NC}"
        
        cd "$CACHE" || true
        
        # Try cloning via SSH first
        if git clone "ssh://aur@aur.archlinux.org/$package_name.git"; then
            echo -e "${GREEN}${MESSAGES["ssh_clone_success"]}${NC}"
        else
            echo -e "${YELLOW}${MESSAGES["ssh_failed_trying_https"]}${NC}"
            if git clone "https://aur.archlinux.org/$package_name.git"; then
                echo -e "${GREEN}${MESSAGES["https_clone_success"]}${NC}"
            else
                echo -e "${RED}${MESSAGES["error_cannot_clone"]}${NC}"
                printf "${MESSAGES["check_package_name"]}%s\n" "$package_name"
                exit 1
            fi
        fi
    fi
    
    # Enter package directory
    cd "$CACHE/$package_name" || true
    
    # Ask about editing PKGBUILD
    read -rp "${MESSAGES["edit_pkgbuild"]} " edit_choice
    
    if [[ $edit_choice =~ ^[SsYy]$ ]]; then
        # Define editor in order of preference
        if [ -z "$EDITOR" ]; then
            if command -v nvim &> /dev/null; then
                EDITOR="nvim"
            elif command -v vim &> /dev/null; then
                EDITOR="vim"
            elif command -v nano &> /dev/null; then
                EDITOR="nano"
            elif command -v vi &> /dev/null; then
                EDITOR="vi"
            else
                echo -e "${RED}${MESSAGES["no_editor_found"]}${NC}"
                echo "${MESSAGES["set_editor"]}:"
                echo "${MESSAGES["export_editor"]}"
                echo "${MESSAGES["add_to_config"]}"
                echo "${MESSAGES["available_editors"]}"
                exit 1
            fi
        fi
        
        echo -e "${BLUE}$(printf "${MESSAGES["opening_pkgbuild"]}%s\n" "$EDITOR")${NC}"
        $EDITOR PKGBUILD
    fi
    
    # Ask about how to build the package
    echo ""
    echo -e "${BLUE}${MESSAGES["build_options"]}${NC}"
    echo "${MESSAGES["generate_only"]}"
    echo "${MESSAGES["generate_and_install"]}"
    echo "${MESSAGES["generate_force_install"]}"
    
    read -rp "${MESSAGES["choose_option"]} " build_choice
    
    case $build_choice in
        1)
            echo -e "${BLUE}${MESSAGES["generating_package"]}${NC}"
            f_makepkg -s
            ;;
        2)
            echo -e "${BLUE}${MESSAGES["generating_installing"]}${NC}"
            f_makepkg -si
            ;;
        3)
            echo -e "${BLUE}${MESSAGES["generating_force_installing"]}${NC}"
            f_makepkg -sfi
            ;;
        *)
            echo -e "${YELLOW}${MESSAGES["invalid_option"]}${NC}"
            ;;
    esac
    
}

# Main search function
main_search() {
    local search_term="$1"
    local limit="${2:-20}"
    local detail_limit="${3:-0}"
    
    check_dependencies
    
    if command -v curl &> /dev/null; then
        response=$(curl -s "${AUR_API_URL}$search_term")
    elif command -v wget &> /dev/null; then
        response=$(wget -qO- "${AUR_API_URL}$search_term")
    else
        echo -e "${RED}${MESSAGES["error_no_curl_wget"]}${NC}"
        exit 1
    fi
    
    search_aur "$search_term" "$limit"
    
    # Extract result count
    result_count=$(echo "$response" | grep -o '"resultcount":[0-9]*' | cut -d: -f2)
    
    if [ "$result_count" -gt 0 ]; then
        # If detail_limit was specified, show details automatically
        if [ "$detail_limit" != "0" ]; then
            detailed_search "$response" "$detail_limit"
        else
            echo ""
            read -rp "${MESSAGES["see_detailed_info"]} " detail_choice
            
            if [[ $detail_choice =~ ^[SsYy]$ ]]; then
                detailed_search "$response"
            fi
        fi
        
        save_results "$response"
    fi
}

# Help menu
show_help() {
    echo -e "${GREEN}${MESSAGES["script_title"]}${NC}"
    echo "======================"
    echo "${MESSAGES["script_description"]}"
    echo ""
    echo "${MESSAGES["usage"]}"
    printf "${MESSAGES["default_search"]}%s\n" "${0##*/}"
    printf "${MESSAGES["search_with_limit"]}%s\n" "${0##*/}"
    printf "${MESSAGES["search_option"]}%s\n" "${0##*/}"
    printf "${MESSAGES["search_option_limit"]}%s\n" "${0##*/}"
    printf "${MESSAGES["detailed_option"]}%s\n" "${0##*/}"
    printf "${MESSAGES["detailed_option_limit"]}%s\n" "${0##*/}"
    printf "${MESSAGES["install_option"]}%s\n" "${0##*/}"
    printf "${MESSAGES["info_option"]}%s\n" "${0##*/}"
    printf "${MESSAGES["remove_option"]}%s\n" "${0##*/}"
    printf "${MESSAGES["remove_all_option"]}%s\n" "${0##*/}"
    printf "${MESSAGES["help_option"]}%s\n" "${0##*/}"
    echo ""
    echo "${MESSAGES["examples"]}"
    printf "${MESSAGES["example1"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example2"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example3"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example4"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example5"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example6"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example7"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example8"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example9"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example10"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example11"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example12"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example13"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example14"]}%s\n" "${0##*/}"
    printf "${MESSAGES["example15"]}%s\n" "${0##*/}"
    echo ""
    echo "${MESSAGES["dependencies"]}"
    echo "${MESSAGES["deps_curl_wget"]}"
    echo "${MESSAGES["deps_git"]}"
    echo "${MESSAGES["deps_makepkg"]}"
    echo ""
    echo "${MESSAGES["cache"]}"
    printf "${MESSAGES["cache_location"]}%s\n" "$SCRIPT_REAL_NAME"
    echo ""
    echo "${MESSAGES["search_format"]}"
    echo "${MESSAGES["format_description"]}"
}

# Process arguments
if [ $# -eq 0 ]; then
    show_help
    exit 1
fi

case "$1" in
    -h|--help)
        show_help
        exit 0
        ;;
    -Ss| -s|--search)
        if [ $# -lt 2 ]; then
            echo -e "${RED}${MESSAGES["error_no_search_term"]}${NC}"
            printf "${MESSAGES["usage_search"]}%s\n" "${0##*/}"
            exit 1
        fi
        
        search_term="$2"
        
        if [ $# -ge 3 ]; then
            # We have a third argument (full or number)
            limit="$3"
            main_search "$search_term" "$limit" 0
        else
            # Only search term
            main_search "$search_term"
        fi
        ;;
    -d|--detailed)
        if [ $# -lt 2 ]; then
            echo -e "${RED}${MESSAGES["error_no_search_term"]}${NC}"
            printf "${MESSAGES["usage_search"]}%s\n" "${0##*/}"
            exit 1
        fi
        
        search_term="$2"
        
        if [ $# -ge 3 ]; then
            # We have a third argument (full or number)
            detail_limit="$3"
            main_search "$search_term" "$detail_limit" "$detail_limit"
        else
            # Only search term (default: 5 detailed results)
            main_search "$search_term" 5 5
        fi
        ;;
    -i| -S|--install)
        if [ $# -lt 2 ]; then
            echo -e "${RED}${MESSAGES["error_no_package_name"]}${NC}"
            printf "${MESSAGES["usage_install"]}%s\n" "${0##*/}"
            exit 1
        fi
        install_package "$2"
        ;;
    -Qi|--info|--query-info)
        if [ $# -lt 2 ]; then
            echo -e "${RED}${MESSAGES["error_no_package_name"]}${NC}"
            printf "${MESSAGES["usage_info"]}%s\n" "${0##*/}"
            printf "${MESSAGES["example_info"]}%s\n" "${0##*/}"
            exit 1
        fi
        pacman -Qi "$2"
        ;;
    -R|--remove)
        if [ $# -lt 2 ]; then
            echo -e "${RED}${MESSAGES["error_no_package_name"]}${NC}"
            printf "${MESSAGES["usage_remove"]}%s\n" "${0##*/}"
            printf "${MESSAGES["example_remove"]}%s\n" "${0##*/}"
            exit 1
        fi
        sudo pacman -R "$2"
        ;;
    -Rcs|--remove-all|--purge|--remove-with-deps)
        if [ $# -lt 2 ]; then
            echo -e "${RED}${MESSAGES["error_no_package_name"]}${NC}"
            printf "${MESSAGES["usage_remove_all"]}%s\n" "${0##*/}"
            printf "${MESSAGES["example_remove_all"]}%s\n" "${0##*/}"
            exit 1
        fi
        sudo pacman -Rcs "$2"
        ;;
    *)
        # Default mode: simple search
        search_term="$1"
        
        if [ $# -ge 2 ]; then
            # We have a second argument (full or number)
            if [[ "$2" =~ ^[0-9]+$ ]] || [ "$2" = "full" ]; then
                main_search "$search_term" "$2" 0
            else
                echo -e "${YELLOW}$(printf "${MESSAGES["warning_arg_ignored"]}%s\n" "$2" "$search_term")${NC}"
                main_search "$search_term"
            fi
        else
            # Only search term
            main_search "$search_term"
        fi
        ;;
esac