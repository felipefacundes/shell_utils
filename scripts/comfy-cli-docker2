#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes
# Source: https://github.com/comfyanonymous/ComfyUI

container="comfy"
docker_root="${HOME}/.dockers"
docker_base="${docker_root}/${container}"
docker_file="${docker_base}/Dockerfile"

# Function to display help menu
show_help() {
    cat << EOF

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   COMFYUI DOCKER INSTALLER
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPTION:
    Instala e executa ComfyUI em container Docker

USAGE:
    ${0##*/} [install|run|help]

EXAMPLES:
    ${0##*/} install   # Cria o container
    ${0##*/} run       # Executa o container

EOF
    exit 0
}

create_comfy_script() {
    # Cria o script comfy-cli
    cat > "$docker_base/comfy-cli.sh" << 'EOF'
#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes
# Source: https://github.com/comfyanonymous/ComfyUI

py_base="comfy-cli"
py_root="${HOME}/.python"
py_venv="${py_root}/${py_base}"
activate="${py_venv}/bin/activate"

nvidia_universal() {
    echo "âš ï¸ Using CUDA 12.6 as fallback"
    pip install torch==2.9.0 torchvision==0.24.0 torchaudio==2.9.0 --index-url https://download.pytorch.org/whl/cu126
    return 0
}

gpu_detect() {
    if lspci | grep -E "VGA|3D" | grep -i "NVIDIA" >/dev/null 2>&1; then
        echo "ğŸ” NVIDIA GPU detected"        
        nvidia_universal && return
        
    elif lspci | grep -E "VGA|3D" | grep -Ei "AMD|ATI" >/dev/null 2>&1; then
        echo "ğŸ” AMD GPU detected"
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/rocm6.4
        
    elif lspci | grep -E "VGA|3D" | grep -i "Intel" >/dev/null 2>&1; then
        echo "ğŸ” Intel GPU detected"
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/xpu
        
    else
        echo "âš ï¸ No GPU detected - installing for CPU"
        pip install torch torchvision torchaudio
    fi
}

if [[ ! -d "$py_venv" ]]; then
    python -m venv "$py_venv"
    if [[ ! -d "$py_venv" ]]; then
        mkdir -p "$py_venv"
    fi
    cd "$py_venv" || true
    wget https://raw.githubusercontent.com/comfyanonymous/ComfyUI/refs/heads/master/requirements.txt
    #shellcheck source=/dev/null
    [[ -f "$activate" ]] && source "$activate"
    export VIRTUAL_ENV="$py_venv"
    gpu_detect
    pip install -r requirements.txt
    pip install comfy-cli
    echo "âœ… Environment configured. Running: comfy-cli install"
    comfy-cli install
fi

if [[ -z "$VIRTUAL_ENV" ]] && [[ -f "$activate" ]]; then
    export VIRTUAL_ENV="$py_venv"
    #shellcheck source=/dev/null
    source "$activate"
fi

if ! command -v comfy-cli >/dev/null; then
    pip install comfy-cli
fi

if [[ -n "$VIRTUAL_ENV" ]] && [[ "$nv_universal" != "1" ]] && \
    command -v comfy-cli >/dev/null 2>&1; then
    exec comfy-cli "$@"
elif [[ "$nv_universal" != "1" ]]; then
    echo "âŒ Error: Environment not properly configured. Check installation."
    echo "Tip: Execute 'source $activate' manually and try again."
    exit 1
fi
EOF
}

create_docker_context() {
    echo "ğŸ“ Creating Docker build context..."
    [[ -f "$docker_file" ]] && return
    
    # Cria o script primeiro
    create_comfy_script
    
    # Create Dockerfile - VERSÃƒO CORRIGIDA
    cat > "$docker_file" << 'EOF'
FROM archlinux:latest

# Atualiza o sistema e instala pacotes essenciais
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm sudo wget base libsm libxext libxrender mesa clinfo \
    pkgconf libxrandr libxinerama libxi libxcursor libglvnd pciutils ocl-icd \
    base-devel python python-pip python-pipx git zsh pciutils && \
    pacman -Scc --noconfirm

# Cria usuÃ¡rio comfy
RUN useradd -m -G wheel -s /bin/zsh comfy && \
    echo "comfy:123" | chpasswd && \
    echo "comfy ALL=(ALL:ALL) NOPASSWD:ALL" >> /etc/sudoers.d/comfy && \
    chmod 0440 /etc/sudoers.d/comfy

# ConfiguraÃ§Ãµes do usuÃ¡rio comfy
USER comfy
WORKDIR /home/comfy

# Cria e configura o diretÃ³rio .local/bin
RUN mkdir -p /home/comfy/.local/bin && \
    chown -R comfy:comfy /home/comfy/.local

# Configura o PATH para incluir ~/.local/bin
ENV PATH="/home/comfy/.local/bin:${PATH}"
RUN echo 'export PATH="/home/comfy/.local/bin:$PATH"' >> /home/comfy/.zshrc && \
    echo 'export PATH="/home/comfy/.local/bin:$PATH"' >> /home/comfy/.bashrc

# Instala o pipx e configura
RUN pipx ensurepath

# Copia o script comfy-cli para ~/.local/bin e torna executÃ¡vel
COPY --chown=comfy:comfy comfy-cli.sh /home/comfy/.local/bin/comfy-cli
RUN chmod +x /home/comfy/.local/bin/comfy-cli

# MantÃ©m o container em execuÃ§Ã£o com ZSH
CMD ["/bin/zsh"]
EOF
}

install_container() {
    if [[ ! -d "$docker_base" ]]; then
        mkdir -p "$docker_base"
        create_docker_context
        echo "ğŸ”¨ Building Docker image..."
        docker build -t "$container" -f "$docker_file" "$docker_base"
        
        if [[ $? -eq 0 ]]; then
            echo "âœ… Container created successfully!"
            echo "ğŸ”‘ Login: comfy | Password: 123"
            echo "ğŸ“¦ Comfy-cli installed at: /home/comfy/.local/bin/comfy-cli"
        else
            echo "âŒ Failed to create container"
            exit 1
        fi
    else
        echo "â„¹ï¸  Container already exists at: $docker_base"
        echo "ğŸ’¡ To rebuild, remove directory first: rm -rf $docker_base"
    fi
}

run_container() {
    if docker images | grep -q "^$container "; then
        echo "ğŸš€ Starting container..."
        
        # Verifica se container jÃ¡ existe
        if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
            if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
                echo "ğŸ“¦ Starting existing container..."
                docker start "$container" >/dev/null 2>&1
            else
                echo "ğŸ“¦ Container already running..."
            fi
        else
            echo "ğŸ³ Creating new container..."
            docker run -d \
                --name "$container" \
                -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
                -e DISPLAY="$DISPLAY" \
                --device /dev/dri \
                "$container" >/dev/null 2>&1
        fi
        
        # Entra no container
        echo "ğŸ”§ Entering container..."
        echo "ğŸ’¡ Type 'comfy-cli' to use the comfy-cli command"
        docker exec -it "$container" zsh
    else
        echo "âŒ Container '$container' not found"
        echo "ğŸ’¡ Run first: ${0##*/} install"
        exit 1
    fi
}

# Processa argumentos
case "${1:-}" in
    "install"|"i")
        install_container
        ;;
    "run"|"r")
        run_container
        ;;
    "help"|"h"|""|"--help")
        show_help
        ;;
    *)
        echo "âŒ Invalid option: $1"
        echo "ğŸ’¡ Use: ${0##*/} help"
        exit 1
        ;;
esac