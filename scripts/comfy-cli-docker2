#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes
# Source: https://github.com/comfyanonymous/ComfyUI

container="comfy"
docker_root="${HOME}/.dockers"
docker_base="${docker_root}/${container}"
docker_file="${docker_base}/Dockerfile"

# Function to display help menu
show_help() {
    cat << EOF

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   COMFYUI DOCKER INSTALLER
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPTION:
    Install and run ComfyUI in a Docker container

USAGE:
    ${0##*/} [install|run|stop|status|clean|shell|help]

COMMANDS:
    install, i       - Build the Docker image
    run, r           - Start the container in background and enter it
    install_run, ir  - Build and Start the container in background and enter it
    stop, s          - Stop the container
    status, st       - Show container status
    clean, c         - Remove container and image (keeps build context)
    shell, sh        - Enter the container if it's already running
    help, h          - Show this help

EXAMPLES:
    ${0##*/} install, i       # Build the container
    ${0##*/} run, r           # Start the container
    ${0##*/} install_run, ir  # Build and Start the container
    ${0##*/} status, st       # Check status
    ${0##*/} clean, c         # Remove container and image

EOF
    exit 0
}

create_comfy_script() {
    # Create the comfy-cli script
    cat > "$docker_base/comfy-cli.sh" << 'EOF'
#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes
# Source: https://github.com/comfyanonymous/ComfyUI

py_base="comfy-cli"
py_root="${HOME}/.python"
py_venv="${py_root}/${py_base}"
activate="${py_venv}/bin/activate"

nvidia_universal() {
    echo "âš ï¸ Using CUDA 12.6 as fallback"
    pip install torch==2.9.0 torchvision==0.24.0 torchaudio==2.9.0 --index-url https://download.pytorch.org/whl/cu126
    return 0
}

gpu_detect() {
    if lspci | grep -E "VGA|3D" | grep -i "NVIDIA" >/dev/null 2>&1; then
        echo "ğŸ” NVIDIA GPU detected"        
        nvidia_universal && return
        
    elif lspci | grep -E "VGA|3D" | grep -Ei "AMD|ATI" >/dev/null 2>&1; then
        echo "ğŸ” AMD GPU detected"
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/rocm6.4
        
    elif lspci | grep -E "VGA|3D" | grep -i "Intel" >/dev/null 2>&1; then
        echo "ğŸ” Intel GPU detected"
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/xpu
        
    else
        echo "âš ï¸ No GPU detected - installing for CPU"
        pip install torch torchvision torchaudio
    fi
}

if [[ ! -d "$py_venv" ]]; then
    python -m venv "$py_venv"
    if [[ ! -d "$py_venv" ]]; then
        mkdir -p "$py_venv"
    fi
    cd "$py_venv" || true
    wget https://raw.githubusercontent.com/comfyanonymous/ComfyUI/refs/heads/master/requirements.txt
    #shellcheck source=/dev/null
    [[ -f "$activate" ]] && source "$activate"
    export VIRTUAL_ENV="$py_venv"
    gpu_detect
    pip install -r requirements.txt
    pip install comfy-cli
    echo "âœ… Environment configured. Running: comfy-cli install"
    comfy-cli install
fi

if [[ -z "$VIRTUAL_ENV" ]] && [[ -f "$activate" ]]; then
    export VIRTUAL_ENV="$py_venv"
    #shellcheck source=/dev/null
    source "$activate"
fi

if ! command -v comfy-cli >/dev/null; then
    pip install comfy-cli
fi

if [[ -n "$VIRTUAL_ENV" ]] && [[ "$nv_universal" != "1" ]] && \
    command -v comfy-cli >/dev/null 2>&1; then
    exec comfy-cli "$@"
elif [[ "$nv_universal" != "1" ]]; then
    echo "âŒ Error: Environment not properly configured. Check installation."
    echo "Tip: Execute 'source $activate' manually and try again."
    exit 1
fi
EOF
}

create_docker_context() {
    echo "ğŸ“ Creating Docker build context..."
    [[ -f "$docker_file" ]] && return
    
    # Create the script first
    create_comfy_script
    
    # Create fixed Dockerfile
    cat > "$docker_file" << 'EOF'
FROM python:3.13-slim

# Install system dependencies for Debian Trixie/Sid
RUN apt-get update && apt-get install -y \
    wget curl git sudo libglib2.0-0 \
    libsm6 libxext6 libxrender1 \
    libgl1 libgomp1 ocl-icd-libopencl1 \
    clinfo pciutils libglvnd0 libglx0 \
    libegl1 zsh screen tmux \
    && rm -rf /var/lib/apt/lists/*

# For NVIDIA GPU support in container
RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config \
    libxcursor-dev \
    libxrandr-dev \
    libxinerama-dev \
    libxi-dev \
    && rm -rf /var/lib/apt/lists/*

# Create comfy user - FIX: use 'sudo' group instead of 'wheel'
RUN useradd -m -G sudo -s /bin/zsh comfy && \
    echo "comfy:123" | chpasswd && \
    echo "comfy ALL=(ALL:ALL) NOPASSWD:ALL" >> /etc/sudoers.d/comfy && \
    chmod 0440 /etc/sudoers.d/comfy

# comfy user settings
USER comfy
WORKDIR /home/comfy

# Create and configure .local/bin directory
RUN mkdir -p /home/comfy/.local/bin && \
    chown -R comfy:comfy /home/comfy/.local

# Configure PATH to include ~/.local/bin
ENV PATH="/home/comfy/.local/bin:${PATH}"

# Add shell_utils settings to .bashrc and .zshrc
RUN echo 'export PATH="/home/comfy/.local/bin:$PATH"' >> /home/comfy/.zshrc && \
    echo 'export PATH="/home/comfy/.local/bin:$PATH"' >> /home/comfy/.bashrc && \
    echo '' >> /home/comfy/.bashrc && \
    echo '# Shell Utils Installation' >> /home/comfy/.bashrc && \
    echo 'shell_utils_dir=~/.shell_utils/' >> /home/comfy/.bashrc && \
    echo 'if ! test -d "${shell_utils_dir}"; then' >> /home/comfy/.bashrc && \
    echo '    bash -c "$(curl -fsSL https://raw.githubusercontent.com/felipefacundes/shell_utils/refs/heads/main/install.sh)"' >> /home/comfy/.bashrc && \
    echo 'fi' >> /home/comfy/.bashrc && \
    echo 'if ! test -f "${shell_utils_dir}/scripts/comfy-cli"; then' >> /home/comfy/.bashrc && \
    echo '    rm "${shell_utils_dir}/scripts/comfy-cli"' >> /home/comfy/.bashrc && \
    echo 'fi' >> /home/comfy/.bashrc && \
    echo '' >> /home/comfy/.bashrc && \
    echo 'echo "Starting ComfyUI in background. Please wait..."' >> /home/comfy/.bashrc && \
    echo 'comfy-cli launch --background' >> /home/comfy/.bashrc && \
    echo '' >> /home/comfy/.zshrc && \
    echo '# Shell Utils Installation' >> /home/comfy/.zshrc && \
    echo 'shell_utils_dir=~/.shell_utils/' >> /home/comfy/.zshrc && \
    echo 'if ! test -d "${shell_utils_dir}"; then' >> /home/comfy/.zshrc && \
    echo '    bash -c "$(curl -fsSL https://raw.githubusercontent.com/felipefacundes/shell_utils/refs/heads/main/install.sh)"' >> /home/comfy/.zshrc && \
    echo 'fi' >> /home/comfy/.zshrc && \
    echo 'if ! test -f "${shell_utils_dir}/scripts/comfy-cli"; then' >> /home/comfy/.zshrc && \
    echo '    rm "${shell_utils_dir}/scripts/comfy-cli"' >> /home/comfy/.zshrc && \
    echo 'fi' >> /home/comfy/.zshrc && \
    echo '' >> /home/comfy/.zshrc && \
    echo 'echo "Starting ComfyUI in background. Please wait..."' >> /home/comfy/.zshrc && \
    echo 'comfy-cli launch --background' >> /home/comfy/.zshrc

# Copy comfy-cli script to ~/.local/bin and make executable
COPY --chown=comfy:comfy comfy-cli.sh /home/comfy/.local/bin/comfy-cli
RUN chmod +x /home/comfy/.local/bin/comfy-cli

# IMPORTANT FIX: Keep container running with infinite process
CMD ["tail", "-f", "/dev/null"]
EOF
}

install_container() {
    if [[ ! -d "$docker_base" ]]; then
        mkdir -p "$docker_base"
        create_docker_context
        echo "ğŸ”¨ Building Docker image..."
        
        if docker build -t "$container" -f "$docker_file" "$docker_base"; then
            echo "âœ… Container image created successfully!"
            echo "ğŸ”‘ Login: comfy | Password: 123"
            echo "ğŸ“¦ Comfy-cli installed at: /home/comfy/.local/bin/comfy-cli"
            echo "ğŸ’¡ Run: ${0##*/} run  # to start the container"
        else
            echo "âŒ Failed to create container"
            exit 1
        fi
    else
        echo "â„¹ï¸  Container image already exists at: $docker_base"
        echo "ğŸ’¡ To rebuild, remove directory first: rm -rf $docker_base"
    fi
}

run_container() {
    if docker images | grep -q "^$container "; then
        echo "ğŸš€ Starting container..."
        
        # Check if container already exists and is running
        if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
            echo "âœ… Container '$container' is already running!"
            echo "ğŸ’¡ Use '${0##*/} shell' to enter or '${0##*/} stop' to stop it"
            read -p "Enter container now? [Y/n] " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Nn]$ ]]; then
                docker exec -it "$container" zsh
            fi
            return
        fi
        
        # If exists but stopped, remove to recreate
        if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
            echo "ğŸ”„ Removing stopped container..."
            docker rm "$container" 2>/dev/null
        fi
        
        # Mount variables for configuration
        local gpu_args=""
        local display_args=""
        
        # Check NVIDIA
        if command -v nvidia-smi >/dev/null 2>&1; then
            echo "ğŸ® NVIDIA GPU detected, enabling GPU support..."
            gpu_args="--gpus all"
        # Check AMD/Intel
        elif [[ -d "/dev/dri" ]]; then
            echo "ğŸ® GPU device detected (/dev/dri), enabling GPU support..."
            gpu_args="--device /dev/dri"
        fi
        
        # Check X11
        if [[ -n "$DISPLAY" ]] && [[ -S "/tmp/.X11-unix/X${DISPLAY#*:}" ]]; then
            display_args="-v /tmp/.X11-unix:/tmp/.X11-unix:rw -e DISPLAY=$DISPLAY"
            echo "ğŸ¨ X11 display enabled: $DISPLAY"
        fi
        
        # CRITICAL: Run in background with -d (detached)
        echo "ğŸ³ Creating container in background mode..."
        if docker run -d \
            --name "$container" \
            --hostname "$container" \
            --restart unless-stopped \
            $gpu_args \
            $display_args \
            -p 8188:8188 \
            -p 443:443 \
            "$container" >/dev/null 2>&1; then
            
            sleep 2  # Wait for container to start
            
            # Check if it's actually running
            if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
                echo "âœ… Container '$container' started successfully in background!"
                echo ""
                echo "ğŸ“Š Container status:"
                docker ps --filter "name=$container" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
                echo ""
                echo "ğŸ”§ Available commands:"
                echo "   ${0##*/} shell    - Enter container"
                echo "   ${0##*/} stop     - Stop container"
                echo "   ${0##*/} status   - Check status"
                echo "   docker logs $container  - View logs"
                echo ""
                
                docker exec -it "$container" zsh
            else
                echo "âŒ Container failed to start in background"
                echo "Checking logs..."
                docker logs "$container" 2>&1 | tail -20
                exit 1
            fi
        else
            echo "âŒ Failed to start container"
            exit 1
        fi
    else
        echo "âŒ Container image '$container' not found"
        echo "ğŸ’¡ Run first: ${0##*/} install"
        exit 1
    fi
}

stop_container() {
    if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        echo "ğŸ›‘ Stopping container '$container'..."
        docker stop "$container"
        echo "âœ… Container stopped"
    elif docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
        echo "â„¹ï¸  Container '$container' is already stopped"
    else
        echo "âŒ Container '$container' not found"
    fi
}

status_container() {
    echo "ğŸ“Š Docker containers status:"
    echo ""
    
    # Show specific container if exists
    if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
        echo "Container '$container':"
        docker ps -a --filter "name=$container" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.Ports}}"
        echo ""
        
        # If running, show more information
        if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
            echo "ğŸ“ˆ Resource usage:"
            docker stats "$container" --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"
            echo ""
            echo "ğŸ“ Last logs (tail):"
            docker logs "$container" --tail 10 2>/dev/null || echo "No logs available"
        fi
    else
        echo "âŒ Container '$container' not found"
        echo ""
        echo "All containers:"
        docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.Ports}}"
    fi
}

shell_container() {
    if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        echo "ğŸšª Entering container '$container'..."
        docker exec -it "$container" zsh
    elif docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
        echo "âŒ Container '$container' exists but is not running"
        read -p "Start it now? [Y/n] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            docker start "$container"
            sleep 2
            docker exec -it "$container" zsh
        fi
    else
        echo "âŒ Container '$container' not found"
        echo "ğŸ’¡ Run first: ${0##*/} install"
        exit 1
    fi
}

clean_container() {
    echo "ğŸ§¹ Cleaning up container and image..."
    
    # Stop container if running
    if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        echo "ğŸ›‘ Stopping container..."
        docker stop "$container"
    fi
    
    # Remove container if exists
    if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
        echo "ğŸ—‘ï¸  Removing container..."
        docker rm "$container"
        echo "âœ… Container removed"
    else
        echo "â„¹ï¸  Container not found"
    fi
    
    # Remove image if exists
    if docker images | grep -q "^$container "; then
        echo "ğŸ—‘ï¸  Removing image..."
        docker rmi "$container"
        echo "âœ… Image removed"
    else
        echo "â„¹ï¸  Image not found"
    fi
    
    echo ""
    echo "ğŸ“ Build context is preserved at: $docker_base"
    echo "ğŸ’¡ To completely remove everything: rm -rf $docker_base"
}

# Process arguments
case "${1:-}" in
    "install"|"i")
        install_container
        ;;
    "run"|"r")
        run_container
        ;;
    "install_run"|"ir")
        install_container
        run_container
        ;;
    "stop"|"s")
        stop_container
        ;;
    "status"|"st")
        status_container
        ;;
    "clean"|"c")
        clean_container
        ;;
    "shell"|"sh")
        shell_container
        ;;
    "help"|"h"|""|"--help")
        show_help
        ;;
    *)
        echo "âŒ Invalid option: $1"
        echo "ğŸ’¡ Use: ${0##*/} help"
        exit 1
        ;;
esac