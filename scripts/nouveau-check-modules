#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes
#
# SCRIPT PEDAGÓGICO: CONFIGURAÇÃO NOUVEAU + NVK NO ARCH LINUX
#
# Este script ajuda a configurar os drivers de código aberto para NVIDIA:
# - Nouveau: Driver de kernel para suporte básico
# - NVK: Driver Vulkan moderno desenvolvido pela Collabora
#
# OBJETIVO EDUCATIVO: Ensinar como funciona a stack de gráficos open source
# para placas NVIDIA no Arch Linux.

set -e  # Para o script em caso de erro

# Array associativa para mensagens multilíngue
declare -A MESSAGES

if [[ "${LANG,,}" =~ pt_ ]]; then
    # Mensagens em português
    MESSAGES=(
        ["title"]="CONFIGURADOR EDUCATIVO: NOUVEAU + NVK NO ARCH LINUX"
        ["architecture_title"]="ARQUITETURA DOS DRIVERS NVIDIA OPEN SOURCE:"
        ["architecture_line1"]="1. NOUVEAU: Driver de kernel (módulo) que fornece suporte básico à GPU"
        ["architecture_line2"]="2. NVK:     Driver Vulkan moderno que roda sobre o Nouveau"
        ["architecture_line3"]="3. ZINK:    Camada OpenGL que converte chamadas OpenGL para Vulkan (usa NVK)"
        ["architecture_ideal"]="Esta configuração é ideal para:"
        ["architecture_ideal1"]="- Software livre puro"
        ["architecture_ideal2"]="- Desenvolvimento"
        ["architecture_ideal3"]="- Usuários que preferem open source"
        ["architecture_ideal4"]="- Testes da stack gráfica moderna"
        ["performance_warning"]="PERFORMANCE: Em placas antigas (Maxwell, Pascal), o desempenho pode ser"
        ["performance_warning2"]="limitado devido à falta de reclocking. Placas Turing+ funcionam melhor."
        ["checking_nouveau"]="Verificando se o módulo Nouveau está carregado..."
        ["nouveau_loaded"]="Módulo Nouveau está carregado e funcionando"
        ["nouveau_not_loaded"]="Módulo Nouveau não está carregado"
        ["checking_conflicts"]="Verificando conflitos com drivers NVIDIA proprietários..."
        ["nvidia_loaded"]="Módulos NVIDIA proprietários detectados! Eles conflitam com o Nouveau."
        ["remove_nvidia"]="Para remover os drivers NVIDIA proprietários:"
        ["nvidia_packages"]="Pacotes NVIDIA detectados. Eles podem causar conflitos."
        ["packages_found"]="Pacotes encontrados:"
        ["no_conflicts"]="Nenhum conflito grave detectado com drivers NVIDIA"
        ["checking_mkinitcpio"]="Verificando configuração do mkinitcpio..."
        ["mkinitcpio_not_found"]="Arquivo %s não encontrado!"
        ["mkinitcpio_warning"]="Você pode não ter o mkinitcpio instalado ou usar outro gerenciador (dracut)"
        ["modules_not_found"]="Linha MODULES= não encontrada em %s"
        ["modules_normal"]="Isso é normal - vamos configurar os módulos necessários"
        ["nvidia_in_modules"]="Módulos NVIDIA detectados no mkinitcpio! Eles precisam ser removidos."
        ["current_line"]="Linha atual: %s"
        ["edit_mkinitcpio"]="Você precisa editar %s e remover: nvidia, nvidia_modeset, nvidia_uvm"
        ["nouveau_configured"]="Módulo Nouveau já configurado no mkinitcpio"
        ["nouveau_not_configured"]="Módulo Nouveau não está configurado no mkinitcpio"
        ["setting_blacklist"]="Configurando blacklist para drivers NVIDIA..."
        ["blacklist_configured"]="Blacklist configurado em %s"
        ["setting_modules"]="Configurando módulos no mkinitcpio..."
        ["pause_explain"]="Agora vamos configurar o mkinitcpio para incluir o módulo Nouveau na imagem initramfs. Isso garante que o driver seja carregado durante o boot."
        ["backup_created"]="Backup criado: %s"
        ["module_configured"]="Módulo Nouveau configurado no mkinitcpio"
        ["updating_initramfs"]="Atualizando imagem initramfs..."
        ["pause_initramfs"]="Agora vamos regenerar a imagem initramfs com o novo módulo Nouveau. Esta imagem é carregada durante a inicialização do sistema."
        ["initramfs_success"]="Initramfs atualizado com sucesso"
        ["initramfs_failed"]="Falha ao atualizar initramfs"
        ["checking_packages"]="Verificando pacotes necessários..."
        ["missing_packages"]="Pacotes faltando: %s"
        ["install_prompt"]="Deseja instalar os pacotes faltantes? [s/N] "
        ["packages_installed"]="Pacotes instalados"
        ["packages_missing"]="Alguns pacotes necessários não estão instalados"
        ["all_packages_ok"]="Todos os pacotes necessários estão instalados"
        ["checking_nvk"]="Verificando suporte ao NVK..."
        ["nvk_available"]="NVK (driver Vulkan) disponível no Mesa"
        ["nvk_warning"]="NVK pode não estar disponível. Certifique-se de ter Mesa 23.3+"
        ["nvk_info"]="No Arch Linux, você pode precisar do mesa-git para NVK mais recente"
        ["checking_grub"]="Verificando configuração do GRUB..."
        ["grub_not_found"]="Arquivo do GRUB não encontrado em %s"
        ["grub_warning"]="Se você usar outro bootloader, verifique a configuração manualmente"
        ["nvidia_in_grub"]="Parâmetros NVIDIA detectados no GRUB. Eles podem precisar ser removidos."
        ["grub_file"]="Arquivo: %s"
        ["edit_grub"]="Você pode precisar editar este arquivo e remover parâmetros relacionados à NVIDIA"
        ["grub_ok"]="GRUB parece estar configurado corretamente"
        ["testing_config"]="Testando a configuração..."
        ["checking_modules"]="1. Verificando módulos carregados:"
        ["nouveau_ok"]="✓ Nouveau carregado"
        ["nouveau_failed"]="✗ Nouveau não está carregado"
        ["checking_vulkan"]="2. Verificando dispositivos Vulkan:"
        ["vulkan_ok"]="✓ NVK/nouveau detectado no Vulkan"
        ["vulkan_warning"]="NVK/nouveau não detectado no Vulkan"
        ["vulkan_info"]="vulkaninfo não instalado. Instale com: sudo pacman -S vulkan-tools"
        ["checking_opengl"]="3. Verificando renderização OpenGL:"
        ["opengl_ok"]="✓ Nouveau ativo no OpenGL"
        ["opengl_warning"]="Nouveau não detectado no OpenGL"
        ["opengl_info"]="glxinfo não instalado. Instale com: sudo pacman -S mesa-demos"
        ["system_check"]="Iniciando verificação do sistema..."
        ["config_summary"]="RESUMO DA CONFIGURAÇÃO ATUAL:"
        ["conflicts_detected"]="CONFLITOS DETECTADOS:"
        ["conflict1"]="- Drivers NVIDIA proprietários presentes"
        ["conflict2"]="- Configuração incorreta no mkinitcpio"
        ["resolve_problems"]="Vamos resolver esses problemas..."
        ["incomplete_config"]="CONFIGURAÇÃO INCOMPLETA:"
        ["incomplete1"]="- Módulo Nouveau não configurado no mkinitcpio"
        ["complete_config"]="Vamos completar a configuração..."
        ["basic_config_ok"]="CONFIGURAÇÃO BÁSICA OK"
        ["final_adjustments"]="Apenas ajustes finais necessários"
        ["main_config_done"]="CONFIGURAÇÃO PRINCIPAL CONCLUÍDA!"
        ["next_steps"]="PRÓXIMOS PASSOS MANUAIS:"
        ["step1"]="1. REINICIE o sistema: sudo reboot"
        ["step2"]="2. Após reiniciar, verifique se o Nouveau está carregado: lsmod | grep nouveau"
        ["step3"]="3. Teste o Vulkan: vulkaninfo --summary (se vulkan-tools estiver instalado)"
        ["step4"]="4. Para OpenGL, o Zink será usado automaticamente sobre o NVK"
        ["important"]="IMPORTANTE: Se encontrar problemas:"
        ["important1"]="- Verifique se os drivers NVIDIA foram removidos completamente"
        ["important2"]="- Confirme que o módulo Nouveau não está no blacklist"
        ["important3"]="- Consulte o log de boot: dmesg | grep nouveau"
        ["test_prompt"]="Deseja testar a configuração agora (sem reiniciar)? [s/N] "
        ["educational_complete"]="Processo educativo concluído!"
        ["educational_note1"]="Lembre-se: Este script tem propósito educativo para entender"
        ["educational_note2"]="como funciona a stack gráfica open source no Linux."
        ["not_root"]="Não execute este script como root! Use como usuário normal."
    )
else
    # Mensagens em inglês (padrão)
    MESSAGES=(
        ["title"]="EDUCATIONAL CONFIGURATOR: NOUVEAU + NVK ON ARCH LINUX"
        ["architecture_title"]="NVIDIA OPEN SOURCE DRIVERS ARCHITECTURE:"
        ["architecture_line1"]="1. NOUVEAU: Kernel driver (module) that provides basic GPU support"
        ["architecture_line2"]="2. NVK:     Modern Vulkan driver that runs on top of Nouveau"
        ["architecture_line3"]="3. ZINK:    OpenGL layer that converts OpenGL calls to Vulkan (uses NVK)"
        ["architecture_ideal"]="This configuration is ideal for:"
        ["architecture_ideal1"]="- Pure free software"
        ["architecture_ideal2"]="- Development"
        ["architecture_ideal3"]="- Users who prefer open source"
        ["architecture_ideal4"]="- Testing modern graphics stack"
        ["performance_warning"]="PERFORMANCE: On older cards (Maxwell, Pascal), performance may be"
        ["performance_warning2"]="limited due to lack of reclocking. Turing+ cards work better."
        ["checking_nouveau"]="Checking if Nouveau module is loaded..."
        ["nouveau_loaded"]="Nouveau module is loaded and working"
        ["nouveau_not_loaded"]="Nouveau module is not loaded"
        ["checking_conflicts"]="Checking for conflicts with proprietary NVIDIA drivers..."
        ["nvidia_loaded"]="Proprietary NVIDIA modules detected! They conflict with Nouveau."
        ["remove_nvidia"]="To remove proprietary NVIDIA drivers:"
        ["nvidia_packages"]="NVIDIA packages detected. They may cause conflicts."
        ["packages_found"]="Packages found:"
        ["no_conflicts"]="No serious conflicts detected with NVIDIA drivers"
        ["checking_mkinitcpio"]="Checking mkinitcpio configuration..."
        ["mkinitcpio_not_found"]="File %s not found!"
        ["mkinitcpio_warning"]="You may not have mkinitcpio installed or use another manager (dracut)"
        ["modules_not_found"]="MODULES= line not found in %s"
        ["modules_normal"]="This is normal - we'll configure the necessary modules"
        ["nvidia_in_modules"]="NVIDIA modules detected in mkinitcpio! They need to be removed."
        ["current_line"]="Current line: %s"
        ["edit_mkinitcpio"]="You need to edit %s and remove: nvidia, nvidia_modeset, nvidia_uvm"
        ["nouveau_configured"]="Nouveau module already configured in mkinitcpio"
        ["nouveau_not_configured"]="Nouveau module not configured in mkinitcpio"
        ["setting_blacklist"]="Setting up blacklist for NVIDIA drivers..."
        ["blacklist_configured"]="Blacklist configured at %s"
        ["setting_modules"]="Configuring modules in mkinitcpio..."
        ["pause_explain"]="Now we'll configure mkinitcpio to include the Nouveau module in the initramfs image. This ensures the driver is loaded during boot."
        ["backup_created"]="Backup created: %s"
        ["module_configured"]="Nouveau module configured in mkinitcpio"
        ["updating_initramfs"]="Updating initramfs image..."
        ["pause_initramfs"]="Now we'll regenerate the initramfs image with the new Nouveau module. This image is loaded during system boot."
        ["initramfs_success"]="Initramfs updated successfully"
        ["initramfs_failed"]="Failed to update initramfs"
        ["checking_packages"]="Checking required packages..."
        ["missing_packages"]="Missing packages: %s"
        ["install_prompt"]="Do you want to install missing packages? [y/N] "
        ["packages_installed"]="Packages installed"
        ["packages_missing"]="Some required packages are not installed"
        ["all_packages_ok"]="All required packages are installed"
        ["checking_nvk"]="Checking NVK support..."
        ["nvk_available"]="NVK (Vulkan driver) available in Mesa"
        ["nvk_warning"]="NVK may not be available. Make sure you have Mesa 23.3+"
        ["nvk_info"]="On Arch Linux, you may need mesa-git for newer NVK"
        ["checking_grub"]="Checking GRUB configuration..."
        ["grub_not_found"]="GRUB file not found at %s"
        ["grub_warning"]="If you use another bootloader, check the configuration manually"
        ["nvidia_in_grub"]="NVIDIA parameters detected in GRUB. They may need to be removed."
        ["grub_file"]="File: %s"
        ["edit_grub"]="You may need to edit this file and remove NVIDIA-related parameters"
        ["grub_ok"]="GRUB appears to be properly configured"
        ["testing_config"]="Testing configuration..."
        ["checking_modules"]="1. Checking loaded modules:"
        ["nouveau_ok"]="✓ Nouveau loaded"
        ["nouveau_failed"]="✗ Nouveau not loaded"
        ["checking_vulkan"]="2. Checking Vulkan devices:"
        ["vulkan_ok"]="✓ NVK/nouveau detected in Vulkan"
        ["vulkan_warning"]="NVK/nouveau not detected in Vulkan"
        ["vulkan_info"]="vulkaninfo not installed. Install with: sudo pacman -S vulkan-tools"
        ["checking_opengl"]="3. Checking OpenGL rendering:"
        ["opengl_ok"]="✓ Nouveau active in OpenGL"
        ["opengl_warning"]="Nouveau not detected in OpenGL"
        ["opengl_info"]="glxinfo not installed. Install with: sudo pacman -S mesa-demos"
        ["system_check"]="Starting system check..."
        ["config_summary"]="CURRENT CONFIGURATION SUMMARY:"
        ["conflicts_detected"]="CONFLICTS DETECTED:"
        ["conflict1"]="- Proprietary NVIDIA drivers present"
        ["conflict2"]="- Incorrect configuration in mkinitcpio"
        ["resolve_problems"]="Let's resolve these problems..."
        ["incomplete_config"]="INCOMPLETE CONFIGURATION:"
        ["incomplete1"]="- Nouveau module not configured in mkinitcpio"
        ["complete_config"]="Let's complete the configuration..."
        ["basic_config_ok"]="BASIC CONFIGURATION OK"
        ["final_adjustments"]="Only final adjustments needed"
        ["main_config_done"]="MAIN CONFIGURATION COMPLETED!"
        ["next_steps"]="NEXT MANUAL STEPS:"
        ["step1"]="1. REBOOT the system: sudo reboot"
        ["step2"]="2. After reboot, check if Nouveau is loaded: lsmod | grep nouveau"
        ["step3"]="3. Test Vulkan: vulkaninfo --summary (if vulkan-tools is installed)"
        ["step4"]="4. For OpenGL, Zink will be used automatically over NVK"
        ["important"]="IMPORTANT: If you encounter problems:"
        ["important1"]="- Verify that NVIDIA drivers were completely removed"
        ["important2"]="- Confirm that Nouveau module is not blacklisted"
        ["important3"]="- Check boot log: dmesg | grep nouveau"
        ["test_prompt"]="Do you want to test configuration now (without rebooting)? [y/N] "
        ["educational_complete"]="Educational process completed!"
        ["educational_note1"]="Remember: This script has educational purpose to understand"
        ["educational_note2"]="how the open source graphics stack works on Linux."
        ["not_root"]="Do not run this script as root! Use as normal user."
    )
fi

# Cores para output mais amigável
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Arquivos de configuração importantes
MODULES_MKINITCPIO="/etc/mkinitcpio.conf"
MODPROBE_DIR="/etc/modprobe.d"
BOOT_LOADER_CONF="/etc/default/grub"

# Função para imprimir mensagens informativas
info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Função para imprimir avisos
warning() {
    echo -e "${YELLOW}[AVISO]${NC} $1"
}

# Função para imprimir sucesso
success() {
    echo -e "${GREEN}[SUCESSO]${NC} $1"
}

# Função para imprimir erros
error() {
    echo -e "${RED}[ERRO]${NC} $1"
}

# Função para pausar e explicar o que está acontecendo
pause_and_explain() {
    echo
    info "PAUSA PEDAGÓGICA: $1"
    read -p "Pressione Enter para continuar..."
    echo
}

# Verifica se o usuário é root
check_root() {
    if [[ $EUID -eq 0 ]]; then
        error "${MESSAGES[not_root]}"
        exit 1
    fi
}

# Explica a arquitetura dos drivers
explain_architecture() {
    echo "================================================================================"
    info "${MESSAGES[architecture_title]}"
    echo
    echo "${MESSAGES[architecture_line1]}"
    echo "${MESSAGES[architecture_line2]}"
    echo "${MESSAGES[architecture_line3]}"
    echo
    echo "${MESSAGES[architecture_ideal]}"
    echo "${MESSAGES[architecture_ideal1]}"
    echo "${MESSAGES[architecture_ideal2]}"
    echo "${MESSAGES[architecture_ideal3]}"
    echo "${MESSAGES[architecture_ideal4]}"
    echo
    warning "${MESSAGES[performance_warning]}"
    warning "${MESSAGES[performance_warning2]}"
    echo "================================================================================"
    echo
}

# Verifica se os módulos Nouveau estão carregados
check_nouveau_loaded() {
    info "${MESSAGES[checking_nouveau]}"
    
    if lsmod | grep -qi nouveau; then
        success "${MESSAGES[nouveau_loaded]}"
        return 0
    else
        warning "${MESSAGES[nouveau_not_loaded]}"
        return 1
    fi
}

# Verifica se há conflitos com drivers NVIDIA proprietários
check_nvidia_conflicts() {
    info "${MESSAGES[checking_conflicts]}"
    
    # Verifica módulos carregados
    if lsmod | grep -qi nvidia; then
        error "${MESSAGES[nvidia_loaded]}"
        echo
        info "${MESSAGES[remove_nvidia]}"
        echo "  sudo pacman -Rs nvidia nvidia-utils nvidia-settings"
        echo
        return 1
    fi
    
    # Verifica pacotes instalados
    if pacman -Qs nvidia > /dev/null 2>&1; then
        warning "${MESSAGES[nvidia_packages]}"
        echo "${MESSAGES[packages_found]}"
        pacman -Qs nvidia | grep "nvidia" | head -5
        echo
    fi
    
    success "${MESSAGES[no_conflicts]}"
    return 0
}

# Verifica configuração do mkinitcpio para módulos Nouveau
check_mkinitcpio_config() {
    info "${MESSAGES[checking_mkinitcpio]}"
    
    if [[ ! -f "$MODULES_MKINITCPIO" ]]; then
        error "$(printf "${MESSAGES[mkinitcpio_not_found]}" "$MODULES_MKINITCPIO")"
        error "${MESSAGES[mkinitcpio_warning]}"
        return 1
    fi
    
    local line_modules=$(grep '^MODULES=' "$MODULES_MKINITCPIO" || true)
    
    if [[ -z "$line_modules" ]]; then
        warning "$(printf "${MESSAGES[modules_not_found]}" "$MODULES_MKINITCPIO")"
        info "${MESSAGES[modules_normal]}"
        return 2
    fi
    
    # Verifica se há módulos NVIDIA que podem causar conflito
    if echo "$line_modules" | grep -q "nvidia"; then
        error "${MESSAGES[nvidia_in_modules]}"
        echo "$(printf "${MESSAGES[current_line]}" "$line_modules")"
        echo
        info "$(printf "${MESSAGES[edit_mkinitcpio]}" "$MODULES_MKINITCPIO")"
        return 1
    fi
    
    # Verifica se Nouveau está nos módulos
    if echo "$line_modules" | grep -q "nouveau"; then
        success "${MESSAGES[nouveau_configured]}"
        return 0
    else
        warning "${MESSAGES[nouveau_not_configured]}"
        return 2
    fi
}

# Configura o blacklist para drivers NVIDIA
setup_nvidia_blacklist() {
    info "${MESSAGES[setting_blacklist]}"
    
    local blacklist_file="$MODPROBE_DIR/blacklist-nvidia.conf"
    
    cat << EOF | sudo tee "$blacklist_file" > /dev/null
# Blacklist para drivers NVIDIA - Configurado pelo script educativo Nouveau+NVK
# Este arquito impede que os drivers NVIDIA proprietários sejam carregados
# permitindo que o Nouveau funcione corretamente.

blacklist nvidia
blacklist nvidia_drm
blacklist nvidia_modeset
blacklist nvidia_uvm
blacklist nvidia_current
blacklist nvidia_current_updates
blacklist nvidia_current_dkms

# Opcional: descomente a linha abaixo se quiser manter o modo de fallback
# alias nvidia off
# alias nvidia_drm off
# alias nvidia_modeset off
# alias nvidia_uvm off
EOF

    success "$(printf "${MESSAGES[blacklist_configured]}" "$blacklist_file")"
}

# Configura os módulos no mkinitcpio
setup_mkinitcpio_modules() {
    info "${MESSAGES[setting_modules]}"
    
    pause_and_explain "${MESSAGES[pause_explain]}"
    
    # Backup do arquivo original
    sudo cp "$MODULES_MKINITCPIO" "$MODULES_MKINITCPIO.backup.$(date +%Y%m%d)"
    success "$(printf "${MESSAGES[backup_created]}" "$MODULES_MKINITCPIO.backup.$(date +%Y%m%d)")"
    
    # Remove qualquer módulo NVIDIA e adiciona nouveau
    sudo sed -i 's/^MODULES=.*/MODULES=(nouveau)/' "$MODULES_MKINITCPIO" 2>/dev/null || {
        # Se a substituição falhar, adiciona a linha MODULES
        echo 'MODULES=(nouveau)' | sudo tee -a "$MODULES_MKINITCPIO" > /dev/null
    }
    
    success "${MESSAGES[module_configured]}"
}

# Atualiza a imagem initramfs
update_initramfs() {
    info "${MESSAGES[updating_initramfs]}"
    
    pause_and_explain "${MESSAGES[pause_initramfs]}"
    
    if sudo mkinitcpio -P; then
        success "${MESSAGES[initramfs_success]}"
    else
        error "${MESSAGES[initramfs_failed]}"
        return 1
    fi
}

# Verifica e instala pacotes necessários
install_required_packages() {
    info "${MESSAGES[checking_packages]}"
    
    local required_packages=()
    local missing_packages=()
    
    # Pacotes essenciais
    required_packages=(
        "mesa"             # Drivers gráficos open source
        "xf86-video-nouveau" # Driver Xorg para Nouveau
        "vulkan-icd-loader" # Loader Vulkan
        "lib32-mesa"       # Suporte a 32-bit (para jogos)
    )
    
    # Verifica pacotes instalados
    for pkg in "${required_packages[@]}"; do
        if ! pacman -Qs "$pkg" > /dev/null 2>&1; then
            missing_packages+=("$pkg")
        fi
    done
    
    if [[ ${#missing_packages[@]} -gt 0 ]]; then
        warning "$(printf "${MESSAGES[missing_packages]}" "${missing_packages[*]}")"
        read -p "${MESSAGES[install_prompt]}" -n 1 -r
        echo
        if [[ $REPLY =~ ^[SsYy]$ ]]; then
            sudo pacman -S --needed "${missing_packages[@]}"
            success "${MESSAGES[packages_installed]}"
        else
            warning "${MESSAGES[packages_missing]}"
        fi
    else
        success "${MESSAGES[all_packages_ok]}"
    fi
    
    # Verifica especificamente o NVK (parte do Mesa)
    info "${MESSAGES[checking_nvk]}"
    if pacman -Qs mesa | grep -q "vulkan-driver" || pacman -Ql mesa 2>/dev/null | grep -q "nvk"; then
        success "${MESSAGES[nvk_available]}"
    else
        warning "${MESSAGES[nvk_warning]}"
        info "${MESSAGES[nvk_info]}"
    fi
}

# Verifica se o GRUB precisa de configuração
check_grub_config() {
    info "${MESSAGES[checking_grub]}"
    
    if [[ ! -f "$BOOT_LOADER_CONF" ]]; then
        warning "$(printf "${MESSAGES[grub_not_found]}" "$BOOT_LOADER_CONF")"
        warning "${MESSAGES[grub_warning]}"
        return 0
    fi
    
    # Verifica parâmetros de kernel que podem conflitar
    if grep -q "nvidia" "$BOOT_LOADER_CONF"; then
        warning "${MESSAGES[nvidia_in_grub]}"
        echo "$(printf "${MESSAGES[grub_file]}" "$BOOT_LOADER_CONF")"
        grep "nvidia" "$BOOT_LOADER_CONF" || true
        echo
        info "${MESSAGES[edit_grub]}"
    else
        success "${MESSAGES[grub_ok]}"
    fi
}

# Testa a configuração
test_configuration() {
    info "${MESSAGES[testing_config]}"
    
    echo
    info "${MESSAGES[checking_modules]}"
    if lsmod | grep -i nouveau; then
        success "${MESSAGES[nouveau_ok]}"
    else
        error "${MESSAGES[nouveau_failed]}"
    fi
    
    echo
    info "${MESSAGES[checking_vulkan]}"
    if command -v vulkaninfo > /dev/null 2>&1; then
        if vulkaninfo --summary 2>/dev/null | grep -i "nvk\|nouveau"; then
            success "${MESSAGES[vulkan_ok]}"
        else
            warning "${MESSAGES[vulkan_warning]}"
        fi
    else
        warning "${MESSAGES[vulkan_info]}"
    fi
    
    echo
    info "${MESSAGES[checking_opengl]}"
    if command -v glxinfo > /dev/null 2>&1; then
        if glxinfo | grep -i "nouveau"; then
            success "${MESSAGES[opengl_ok]}"
        else
            warning "${MESSAGES[opengl_warning]}"
        fi
    else
        warning "${MESSAGES[opengl_info]}"
    fi
}

# Função principal
main() {
    echo "================================================================================"
    echo "${MESSAGES[title]}"
    echo "================================================================================"
    echo
    
    check_root
    explain_architecture
    
    info "${MESSAGES[system_check]}"
    echo
    
    # Executa todas as verificações
    check_nouveau_loaded
    check_nvidia_conflicts
    check_mkinitcpio_config
    mkinitcpio_result=$?
    
    check_grub_config
    
    echo
    info "${MESSAGES[config_summary]}"
    echo "=============================="
    
    if [[ $mkinitcpio_result -eq 1 ]]; then
        error "${MESSAGES[conflicts_detected]}"
        error "${MESSAGES[conflict1]}"
        error "${MESSAGES[conflict2]}"
        echo
        info "${MESSAGES[resolve_problems]}"
        echo
        
        setup_nvidia_blacklist
        setup_mkinitcpio_modules
        update_initramfs
        
    elif [[ $mkinitcpio_result -eq 2 ]]; then
        warning "${MESSAGES[incomplete_config]}"
        warning "${MESSAGES[incomplete1]}"
        echo
        info "${MESSAGES[complete_config]}"
        
        setup_mkinitcpio_modules
        update_initramfs
        
    else
        success "${MESSAGES[basic_config_ok]}"
        info "${MESSAGES[final_adjustments]}"
    fi
    
    install_required_packages
    
    echo
    success "${MESSAGES[main_config_done]}"
    echo
    
    info "${MESSAGES[next_steps]}"
    echo "${MESSAGES[step1]}"
    echo "${MESSAGES[step2]}"
    echo "${MESSAGES[step3]}"
    echo "${MESSAGES[step4]}"
    echo
    warning "${MESSAGES[important]}"
    warning "${MESSAGES[important1]}"
    warning "${MESSAGES[important2]}"
    warning "${MESSAGES[important3]}"
    
    echo
    read -p "${MESSAGES[test_prompt]}" -n 1 -r
    echo
    if [[ $REPLY =~ ^[SsYy]$ ]]; then
        test_configuration
    fi
    
    echo
    success "${MESSAGES[educational_complete]}"
    info "${MESSAGES[educational_note1]}"
    info "${MESSAGES[educational_note2]}"
    echo
}

# Executa a função principal
main "$@"