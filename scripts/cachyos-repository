#!/usr/bin/env bash
# License: GPLv3
# Credits: Felipe Facundes

: <<'DOCUMENTATION'
=============================================================================
CachyOS Repository Setup Script
Script to configure CachyOS repositories on Arch Linux
=============================================================================
DOCUMENTATION

#set -euo pipefail

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# =============================================================================
# Internationalization - Message System
# =============================================================================

declare -A MESSAGES

if [[ "${LANG,,}" =~ pt_ ]]; then
    # Portuguese messages
    MESSAGES=(
        # General messages
        [script_title]="Script de Configuração do Repositório CachyOS"
        [success]="SUCESSO"
        [error]="ERRO"
        [warning]="AVISO"
        [info]="INFO"
        
        # Installation messages
        [installing]="Instalando pacotes do repositório CachyOS"
        [setup_gpg]="Configurando chave GPG do CachyOS"
        [gpg_exists]="Chave GPG %s já existe"
        [gpg_downloading]="Baixando chave GPG do CachyOS..."
        [gpg_signing]="Assinando chave GPG localmente..."
        [gpg_failed_download]="Falha ao baixar a chave GPG"
        [gpg_failed_sign]="Falha ao assinar a chave GPG"
        [gpg_success]="Chave GPG configurada com sucesso"
        
        # Package messages
        [package_installed]="Pacote %s já está instalado"
        [package_not_found]="Pacote %s não encontrado"
        [packages_already_installed]="Todos os pacotes necessários já estão instalados"
        [installing_missing]="Instalando pacotes faltantes..."
        [package_url_error]="Não foi possível determinar as URLs dos pacotes"
        [package_install_failed]="Falha ao instalar pacotes do CachyOS"
        [package_install_success]="Pacotes do CachyOS instalados com sucesso"
        
        # Configuration messages
        [final_config]="Configuração Final do CachyOS"
        [edit_config]="Para completar a configuração, adicione os seguintes repositórios ao /etc/pacman.conf:"
        [edit_instruction]="Para editar o arquivo, execute:"
        [preferred_editor]="Ou use seu editor preferido:"
        [update_database]="Após adicionar os repositórios, atualize a base de dados do pacman:"
        [more_info]="Mais informações disponíveis em: %s"
        
        # Error messages
        [sudo_root_warning]="Script não deve ser executado como root/sudo diretamente"
        [sudo_permission_error]="Usuário não tem permissões sudo"
        [interrupted]="Script interrompido pelo usuário"
        [invalid_option]="Opção inválida: %s"
        
        # Help messages
        [usage_title]="Script de Configuração do Repositório CachyOS"
        [usage_install]="Instalar e configurar repositórios CachyOS"
        [usage_help]="Mostrar esta mensagem de ajuda"
        [usage_version]="Mostrar versão do script"
        [usage_description]="Este script automatiza a configuração dos repositórios CachyOS no Arch Linux.
  Ele instala a chave GPG necessária, pacotes do repositório e fornece as
  configurações recomendadas para o /etc/pacman.conf."
        [usage_examples]="Exemplos:"
        [usage_example1]="%s --install    Configurar repositórios CachyOS"
        [usage_example2]="%s --help       Mostrar esta ajuda"
        [requirements]="Requisitos:"
        [req1]="- Sistema Arch Linux ou derivado"
        [req2]="- Permissões sudo"
        [req3]="- Conexão com internet"
        [repo_info]="Repositório CachyOS:"
        
        # Success messages
        [setup_complete]="Configuração do CachyOS completada!"
        [follow_instructions]="Siga as instruções acima para finalizar a configuração."
    )
else
    # English messages (default)
    MESSAGES=(
        # General messages
        [script_title]="CachyOS Repository Setup Script"
        [success]="SUCCESS"
        [error]="ERROR"
        [warning]="WARNING"
        [info]="INFO"
        
        # Installation messages
        [installing]="Installing CachyOS repository packages"
        [setup_gpg]="Setting up CachyOS GPG key"
        [gpg_exists]="GPG key %s already exists"
        [gpg_downloading]="Downloading CachyOS GPG key..."
        [gpg_signing]="Signing GPG key locally..."
        [gpg_failed_download]="Failed to download GPG key"
        [gpg_failed_sign]="Failed to sign GPG key"
        [gpg_success]="GPG key configured successfully"
        
        # Package messages
        [package_installed]="Package %s is already installed"
        [package_not_found]="Package %s not found"
        [packages_already_installed]="All required packages are already installed"
        [installing_missing]="Installing missing packages..."
        [package_url_error]="Could not determine package URLs"
        [package_install_failed]="Failed to install CachyOS packages"
        [package_install_success]="CachyOS packages installed successfully"
        
        # Configuration messages
        [final_config]="Final CachyOS Configuration"
        [edit_config]="To complete the configuration, add the following repositories to /etc/pacman.conf:"
        [edit_instruction]="To edit the file, run:"
        [preferred_editor]="Or use your preferred editor:"
        [update_database]="After adding the repositories, update the pacman database:"
        [more_info]="More information available at: %s"
        
        # Error messages
        [sudo_root_warning]="Script should not be run as root/sudo directly"
        [sudo_permission_error]="User does not have sudo permissions"
        [interrupted]="Script interrupted by user"
        [invalid_option]="Invalid option: %s"
        
        # Help messages
        [usage_title]="CachyOS Repository Setup Script"
        [usage_install]="Install and configure CachyOS repositories"
        [usage_help]="Show this help message"
        [usage_version]="Show script version"
        [usage_description]="This script automates the configuration of CachyOS repositories on Arch Linux.
  It installs the required GPG key, repository packages and provides
  recommended configurations for /etc/pacman.conf."
        [usage_examples]="Examples:"
        [usage_example1]="%s --install    Configure CachyOS repositories"
        [usage_example2]="%s --help       Show this help"
        [requirements]="Requirements:"
        [req1]="- Arch Linux or derivative system"
        [req2]="- Sudo permissions"
        [req3]="- Internet connection"
        [repo_info]="CachyOS Repository:"
        
        # Success messages
        [setup_complete]="CachyOS configuration completed!"
        [follow_instructions]="Follow the instructions above to finalize the configuration."
    )
fi

# =============================================================================
# Configuration
# =============================================================================

readonly CACHYOS_KEY_ID="F3B607488DB35A47"
readonly CACHYOS_KEYSERVER="keyserver.ubuntu.com"
readonly MIRROR_URL="https://mirror.cachyos.org/repo/x86_64/cachyos"
readonly GITHUB_URL="https://github.com/CachyOS/linux-cachyos"

# Package URLs
readonly PACKAGES=(
    "${MIRROR_URL}/cachyos-keyring-20240331-1-any.pkg.tar.zst"
    "${MIRROR_URL}/cachyos-mirrorlist-22-1-any.pkg.tar.zst"
    "${MIRROR_URL}/cachyos-v3-mirrorlist-22-1-any.pkg.tar.zst"
    "${MIRROR_URL}/cachyos-v4-mirrorlist-22-1-any.pkg.tar.zst"
)

# Package names for checking installation
readonly PACKAGE_NAMES=(
    "cachyos-keyring"
    "cachyos-mirrorlist"
    "cachyos-v3-mirrorlist"
    "cachyos-v4-mirrorlist"
)

# =============================================================================
# Utility Functions
# =============================================================================

# Print formatted info message
print_info() {
    echo -e "${BLUE}[${MESSAGES[info]}]${NC} $1"
}

# Print formatted success message
print_success() {
    echo -e "${GREEN}[${MESSAGES[success]}]${NC} $1"
}

# Print formatted warning message
print_warning() {
    echo -e "${YELLOW}[${MESSAGES[warning]}]${NC} $1"
}

# Print formatted error message
print_error() {
    echo -e "${RED}[${MESSAGES[error]}]${NC} $1" >&2
}

# Print header with decorative line
print_header() {
    echo -e "${CYAN}"
    echo "================================================================================"
    echo "$1"
    echo "================================================================================"
    echo -e "${NC}"
}

# Check if user has sudo permissions and is not root
check_sudo() {
    if [[ $EUID -eq 0 ]]; then
        print_warning "${MESSAGES[sudo_root_warning]}"
        return 1
    fi
    
    if ! sudo -v; then
        print_error "${MESSAGES[sudo_permission_error]}"
        return 1
    fi
    return 0
}

# Check if a package is installed
is_package_installed() {
    local package="$1"
    pacman -Qi "$package" &>/dev/null
    return $?
}

# =============================================================================
# Main Functions
# =============================================================================

# Set up GPG key for CachyOS repository
setup_gpg_key() {
    print_header "${MESSAGES[setup_gpg]}"
    
    # Check if GPG key already exists
    if pacman-key --list-keys "$CACHYOS_KEY_ID" &>/dev/null; then
        print_info "$(printf "${MESSAGES[gpg_exists]}" "$CACHYOS_KEY_ID")"
    else
        # Download GPG key
        print_info "${MESSAGES[gpg_downloading]}"
        if ! sudo pacman-key --recv-keys "$CACHYOS_KEY_ID" --keyserver "$CACHYOS_KEYSERVER"; then
            print_error "${MESSAGES[gpg_failed_download]}"
            return 1
        fi
        
        # Sign GPG key locally
        print_info "${MESSAGES[gpg_signing]}"
        if ! sudo pacman-key --lsign-key "$CACHYOS_KEY_ID"; then
            print_error "${MESSAGES[gpg_failed_sign]}"
            return 1
        fi
    fi
    
    print_success "${MESSAGES[gpg_success]}"
    return 0
}

# Install CachyOS repository packages
install_cachyos_packages() {
    print_header "${MESSAGES[installing]}"
    
    local missing_packages=()
    local needs_install=false
    
    # Check which packages are missing
    for package in "${PACKAGE_NAMES[@]}"; do
        if is_package_installed "$package"; then
            print_info "$(printf "${MESSAGES[package_installed]}" "$package")"
        else
            print_warning "$(printf "${MESSAGES[package_not_found]}" "$package")"
            missing_packages+=("$package")
            needs_install=true
        fi
    done
    
    # If all packages are already installed, return early
    if [[ "$needs_install" == false ]]; then
        print_success "${MESSAGES[packages_already_installed]}"
        return 0
    fi
    
    # Install missing packages
    print_info "${MESSAGES[installing_missing]}"
    
    # Build URL list for missing packages
    local install_urls=()
    for url in "${PACKAGES[@]}"; do
        for package in "${missing_packages[@]}"; do
            if [[ "$url" == *"$package"* ]]; then
                install_urls+=("$url")
                break
            fi
        done
    done
    
    # Verify we found URLs for all missing packages
    if [[ ${#install_urls[@]} -eq 0 ]]; then
        print_error "${MESSAGES[package_url_error]}"
        return 1
    fi
    
    # Install packages using pacman -U
    print_info "Executing pacman -U to install packages..."
    if ! sudo pacman -U "${install_urls[@]}" --noconfirm; then
        print_error "${MESSAGES[package_install_failed]}"
        return 1
    fi
    
    print_success "${MESSAGES[package_install_success]}"
    return 0
}

# Show final configuration instructions
show_final_configuration() {
    print_header "${MESSAGES[final_config]}"
    
    echo -e "${YELLOW}${MESSAGES[edit_config]}${NC}"
    echo ""
    echo -e "${CYAN}# ==============================================================================="
    echo "# CachyOS Repositories Configuration"
    echo "# $(printf "${MESSAGES[more_info]}" "$GITHUB_URL")"
    echo "# ==============================================================================="
    echo ""
    echo "# CachyOS repositories For x86-64 (Basic) Support:"
    echo "[cachyos]"
    echo "Include = /etc/pacman.d/cachyos-mirrorlist"
    echo ""
    echo "# CachyOS repositories (add in this order) For x86-64-v3 Support:"
    echo "[cachyos-v3]"
    echo "Include = /etc/pacman.d/cachyos-v3-mirrorlist"
    echo "[cachyos-core-v3]"
    echo "Include = /etc/pacman.d/cachyos-v3-mirrorlist"
    echo "[cachyos-extra-v3]"
    echo "Include = /etc/pacman.d/cachyos-v3-mirrorlist"
    echo "[cachyos]"
    echo "Include = /etc/pacman.d/cachyos-mirrorlist"
    echo ""
    echo "# CachyOS repositories (add in this order) For x86-64-v4 Support:"
    echo "[cachyos-v4]"
    echo "Include = /etc/pacman.d/cachyos-v4-mirrorlist"
    echo "[cachyos-core-v4]"
    echo "Include = /etc/pacman.d/cachyos-v4-mirrorlist"
    echo "[cachyos-extra-v4]"
    echo "Include = /etc/pacman.d/cachyos-v4-mirrorlist"
    echo "[cachyos]"
    echo "Include = /etc/pacman.d/cachyos-mirrorlist"
    echo ""
    echo "# CachyOS repositories (Zen4 optimized) For AMD Zen4 CPUs:"
    echo "[cachyos-znver4]"
    echo "Include = /etc/pacman.d/cachyos-v4-mirrorlist"
    echo "[cachyos-core-znver4]"
    echo "Include = /etc/pacman.d/cachyos-v4-mirrorlist"
    echo "[cachyos-extra-znver4]"
    echo "Include = /etc/pacman.d/cachyos-v4-mirrorlist"
    echo "[cachyos]"
    echo "Include = /etc/pacman.d/cachyos-mirrorlist"
    echo -e "${NC}"
    
    echo -e "${YELLOW}${MESSAGES[edit_instruction]}${NC}"
    echo "sudo vim /etc/pacman.conf"
    echo ""
    echo -e "${YELLOW}${MESSAGES[preferred_editor]}${NC}"
    echo "sudo nano /etc/pacman.conf"
    echo "sudo micro /etc/pacman.conf"
    echo "sudo code /etc/pacman.conf"
    echo ""
    echo -e "${GREEN}${MESSAGES[update_database]}${NC}"
    echo "sudo pacman -Syu"
    echo ""
    echo -e "${CYAN}$(printf "${MESSAGES[more_info]}" "$GITHUB_URL")${NC}"
}

# Display usage information
show_usage() {
    local script_name="$(basename "$0")"
    
    cat << EOF
${MESSAGES[usage_title]}

Usage: $script_name [OPTIONS]

Options:
  -i, --install    ${MESSAGES[usage_install]}
  -h, --help       ${MESSAGES[usage_help]}
  -v, --version    ${MESSAGES[usage_version]}

${MESSAGES[usage_description]}

${MESSAGES[usage_examples]}:
  $(printf "${MESSAGES[usage_example1]}" "$script_name")
  $(printf "${MESSAGES[usage_example2]}" "$script_name")

${MESSAGES[requirements]}:
  ${MESSAGES[req1]}
  ${MESSAGES[req2]}
  ${MESSAGES[req3]}

${MESSAGES[repo_info]}:
  $GITHUB_URL
EOF
}

# Display script version
show_version() {
    echo "CachyOS Repository Setup Script v1.0.0"
    echo "Developed for Arch Linux with CachyOS support"
}

# =============================================================================
# Main Execution
# =============================================================================

main() {
    # Parse command line arguments
    if [[ $# -eq 0 ]]; then
        show_usage
        exit 0
    fi
    
    case "$1" in
        -i|--install)
            print_header "${MESSAGES[script_title]}"
            
            # Check sudo permissions
            if ! check_sudo; then
                print_error "${MESSAGES[sudo_permission_error]}"
                exit 1
            fi
            
            # Step 1: Setup GPG key
            if ! setup_gpg_key; then
                print_error "${MESSAGES[gpg_failed_download]}"
                exit 1
            fi
            
            # Step 2: Install packages
            if ! install_cachyos_packages; then
                print_error "${MESSAGES[package_install_failed]}"
                exit 1
            fi
            
            # Step 3: Show final configuration
            show_final_configuration
            
            print_success "${MESSAGES[setup_complete]}"
            echo ""
            print_info "${MESSAGES[follow_instructions]}"
            ;;
            
        -h|--help)
            show_usage
            ;;
            
        -v|--version)
            show_version
            ;;
            
        *)
            print_error "$(printf "${MESSAGES[invalid_option]}" "$1")"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

# Handle script interruption (Ctrl+C)
trap 'print_error "${MESSAGES[interrupted]}"; exit 1' INT TERM

# Run main function with all arguments
main "$@"